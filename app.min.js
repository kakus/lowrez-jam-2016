(function(c){function h(){}function f(a,d){return function(){a.apply(d,arguments)}}function b(a){if("object"!==typeof this)throw new TypeError("Promises must be constructed via new");if("function"!==typeof a)throw new TypeError("not a function");this._state=0;this._handled=!1;this._value=void 0;this._deferreds=[];m(a,this)}function a(a,b){for(;3===a._state;)a=a._value;0===a._state?a._deferreds.push(b):(a._handled=!0,p(function(){var g=1===a._state?b.onFulfilled:b.onRejected;if(null===g)(1===a._state?
d:e)(b.promise,a._value);else{var c;try{c=g(a._value)}catch(f){e(b.promise,f);return}d(b.promise,c)}}))}function d(a,d){try{if(d===a)throw new TypeError("A promise cannot be resolved with itself.");if(d&&("object"===typeof d||"function"===typeof d)){var c=d.then;if(d instanceof b){a._state=3;a._value=d;g(a);return}if("function"===typeof c){m(f(c,d),a);return}}a._state=1;a._value=d;g(a)}catch(k){e(a,k)}}function e(a,d){a._state=2;a._value=d;g(a)}function g(d){2===d._state&&0===d._deferreds.length&&
setTimeout(function(){d._handled||n(d._value)},1);for(var b=0,e=d._deferreds.length;b<e;b++)a(d,d._deferreds[b]);d._deferreds=null}function k(a,d,b){this.onFulfilled="function"===typeof a?a:null;this.onRejected="function"===typeof d?d:null;this.promise=b}function m(a,b){var g=!1;try{a(function(a){g||(g=!0,d(b,a))},function(a){g||(g=!0,e(b,a))})}catch(c){g||(g=!0,e(b,c))}}var l=setTimeout,p="function"===typeof setImmediate&&setImmediate||function(a){l(a,1)},n=function(a){console.warn("Possible Unhandled Promise Rejection:",
a)},q=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};b.prototype["catch"]=function(a){return this.then(null,a)};b.prototype.then=function(d,e){var g=new b(h);a(this,new k(d,e,g));return g};b.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&q(arguments[0])?arguments[0]:arguments);return new b(function(d,b){function e(c,f){try{if(f&&("object"===typeof f||"function"===typeof f)){var k=f.then;if("function"===typeof k){k.call(f,function(a){e(c,
a)},b);return}}a[c]=f;0===--g&&d(a)}catch(h){b(h)}}if(0===a.length)return d([]);for(var g=a.length,c=0;c<a.length;c++)e(c,a[c])})};b.resolve=function(a){return a&&"object"===typeof a&&a.constructor===b?a:new b(function(d){d(a)})};b.reject=function(a){return new b(function(d,b){b(a)})};b.race=function(a){return new b(function(d,b){for(var e=0,g=a.length;e<g;e++)a[e].then(d,b)})};b._setImmediateFn=function(a){p=a};b._setUnhandledRejectionFn=function(a){n=a};"undefined"!==typeof module&&module.exports?
module.exports=b:c.Promise||(c.Promise=b)})(this);(function(){var c={},h=null,f=!0,b=!1;try{"undefined"!==typeof AudioContext?h=new AudioContext:"undefined"!==typeof webkitAudioContext?h=new webkitAudioContext:f=!1}catch(a){f=!1}if(!f)if("undefined"!==typeof Audio)try{new Audio}catch(d){b=!0}else b=!0;if(f){var e="undefined"===typeof h.createGain?h.createGainNode():h.createGain();e.gain.value=1;e.connect(h.destination)}var g=function(a){this._volume=1;this._muted=!1;this.usingWebAudio=f;this.ctx=h;this.noAudio=b;this._howls=[];this._codecs=a;this.iOSAutoEnable=
!0};g.prototype={volume:function(a){a=parseFloat(a);if(0<=a&&1>=a){this._volume=a;f&&(e.gain.value=a);for(var d in this._howls)if(this._howls.hasOwnProperty(d)&&!1===this._howls[d]._webAudio)for(a=0;a<this._howls[d]._audioNode.length;a++)this._howls[d]._audioNode[a].volume=this._howls[d]._volume*this._volume;return this}return f?e.gain.value:this._volume},mute:function(){this._setMuted(!0);return this},unmute:function(){this._setMuted(!1);return this},_setMuted:function(a){this._muted=a;f&&(e.gain.value=
a?0:this._volume);for(var d in this._howls)if(this._howls.hasOwnProperty(d)&&!1===this._howls[d]._webAudio)for(var b=0;b<this._howls[d]._audioNode.length;b++)this._howls[d]._audioNode[b].muted=a},codecs:function(a){return this._codecs[a]},_enableiOSAudio:function(){var a=this;if(!h||!a._iOSEnabled&&/iPhone|iPad|iPod/i.test(navigator.userAgent)){a._iOSEnabled=!1;var d=function(){var b=h.createBuffer(1,1,22050),e=h.createBufferSource();e.buffer=b;e.connect(h.destination);"undefined"===typeof e.start?
e.noteOn(0):e.start(0);setTimeout(function(){if(e.playbackState===e.PLAYING_STATE||e.playbackState===e.FINISHED_STATE)a._iOSEnabled=!0,a.iOSAutoEnable=!1,window.removeEventListener("touchend",d,!1)},0)};window.addEventListener("touchend",d,!1);return a}}};var k=null,m={};b||(k=new Audio,m={mp3:!!k.canPlayType("audio/mpeg;").replace(/^no$/,""),opus:!!k.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!k.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!k.canPlayType('audio/wav; codecs="1"').replace(/^no$/,
""),aac:!!k.canPlayType("audio/aac;").replace(/^no$/,""),m4a:!!(k.canPlayType("audio/x-m4a;")||k.canPlayType("audio/m4a;")||k.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(k.canPlayType("audio/x-mp4;")||k.canPlayType("audio/mp4;")||k.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!k.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")});var l=new g(m),p=function(a){this._autoplay=a.autoplay||!1;this._buffer=a.buffer||!1;this._duration=a.duration||0;this._format=a.format||null;
this._loop=a.loop||!1;this._loaded=!1;this._sprite=a.sprite||{};this._src=a.src||"";this._pos3d=a.pos3d||[0,0,-.5];this._volume=void 0!==a.volume?a.volume:1;this._urls=a.urls||[];this._rate=a.rate||1;this._model=a.model||null;this._onload=[a.onload||function(){}];this._onloaderror=[a.onloaderror||function(){}];this._onend=[a.onend||function(){}];this._onpause=[a.onpause||function(){}];this._onplay=[a.onplay||function(){}];this._onendTimer=[];this._webAudio=f&&!this._buffer;this._audioNode=[];this._webAudio&&
this._setupAudioNode();"undefined"!==typeof h&&h&&l.iOSAutoEnable&&l._enableiOSAudio();l._howls.push(this);this.load()};p.prototype={load:function(){var a=this,d=null;if(b)a.on("loaderror",Error("No audio support."));else{for(var e=0;e<a._urls.length;e++){var c,f;if(a._format)c=a._format;else if(f=a._urls[e],(c=/^data:audio\/([^;,]+);/i.exec(f))||(c=/\.([^.]+)$/.exec(f.split("?",1)[0])),c)c=c[1].toLowerCase();else{a.on("loaderror",Error("Could not extract format from passed URLs, please add format parameter."));
return}if(m[c]){d=a._urls[e];break}}if(d){a._src=d;if(a._webAudio)n(a,d);else{var k=new Audio;k.addEventListener("error",function(){k.error&&4===k.error.code&&(g.noAudio=!0);a.on("loaderror",{type:k.error?k.error.code:0})},!1);a._audioNode.push(k);k.src=d;k._pos=0;k.preload="auto";k.volume=l._muted?0:a._volume*l.volume();var h=function(){a._duration=Math.ceil(10*k.duration)/10;0===Object.getOwnPropertyNames(a._sprite).length&&(a._sprite={_default:[0,1E3*a._duration]});a._loaded||(a._loaded=!0,a.on("load"));
a._autoplay&&a.play();k.removeEventListener("canplaythrough",h,!1)};k.addEventListener("canplaythrough",h,!1);k.load()}return a}a.on("loaderror",Error("No codec support for selected audio sources."))}},urls:function(a){return a?(this.stop(),this._urls="string"===typeof a?[a]:a,this._loaded=!1,this.load(),this):this._urls},play:function(a,d){var b=this;"function"===typeof a&&(d=a);a&&"function"!==typeof a||(a="_default");if(!b._loaded)return b.on("load",function(){b.play(a,d)}),b;if(!b._sprite[a])return"function"===
typeof d&&d(),b;b._inactiveNode(function(e){e._sprite=a;var g=0<e._pos?e._pos:b._sprite[a][0]/1E3,c=0;b._webAudio?(c=b._sprite[a][1]/1E3-e._pos,0<e._pos&&(g=b._sprite[a][0]/1E3+g)):c=b._sprite[a][1]/1E3-(g-b._sprite[a][0]/1E3);var f=!(!b._loop&&!b._sprite[a][2]),k="string"===typeof d?d:Math.round(Date.now()*Math.random())+"",m;(function(){m=setTimeout(function(){!b._webAudio&&f&&b.stop(k).play(a,k);b._webAudio&&!f&&(b._nodeById(k).paused=!0,b._nodeById(k)._pos=0,b._clearEndTimer(k));b._webAudio||
f||b.stop(k);b.on("end",k)},c/b._rate*1E3);b._onendTimer.push({timer:m,id:k})})();if(b._webAudio){var n=b._sprite[a][0]/1E3,p=b._sprite[a][1]/1E3;e.id=k;e.paused=!1;t(b,[f,n,p],k);b._playStart=h.currentTime;e.gain.value=b._volume;"undefined"===typeof e.bufferSource.start?f?e.bufferSource.noteGrainOn(0,g,86400):e.bufferSource.noteGrainOn(0,g,c):f?e.bufferSource.start(0,g,86400):e.bufferSource.start(0,g,c)}else if(4===e.readyState||!e.readyState&&navigator.isCocoonJS)e.readyState=4,e.id=k,e.currentTime=
g,e.muted=l._muted||e.muted,e.volume=b._volume*l.volume(),setTimeout(function(){e.play()},0);else return b._clearEndTimer(k),function(){var g=a,c=d,f=function(){b.play(g,c);e.removeEventListener("canplaythrough",f,!1)};e.addEventListener("canplaythrough",f,!1)}(),b;b.on("play");"function"===typeof d&&d(k);return b});return b},pause:function(a){var d=this;if(!d._loaded)return d.on("play",function(){d.pause(a)}),d;d._clearEndTimer(a);var b=a?d._nodeById(a):d._activeNode();if(b)if(b._pos=d.pos(null,
a),d._webAudio){if(!b.bufferSource||b.paused)return d;b.paused=!0;"undefined"===typeof b.bufferSource.stop?b.bufferSource.noteOff(0):b.bufferSource.stop(0)}else b.pause();d.on("pause");return d},stop:function(a){var d=this;if(!d._loaded)return d.on("play",function(){d.stop(a)}),d;d._clearEndTimer(a);var b=a?d._nodeById(a):d._activeNode();if(b)if(b._pos=0,d._webAudio){if(!b.bufferSource||b.paused)return d;b.paused=!0;"undefined"===typeof b.bufferSource.stop?b.bufferSource.noteOff(0):b.bufferSource.stop(0)}else isNaN(b.duration)||
(b.pause(),b.currentTime=0);return d},mute:function(a){var d=this;if(!d._loaded)return d.on("play",function(){d.mute(a)}),d;var b=a?d._nodeById(a):d._activeNode();b&&(d._webAudio?b.gain.value=0:b.muted=!0);return d},unmute:function(a){var d=this;if(!d._loaded)return d.on("play",function(){d.unmute(a)}),d;var b=a?d._nodeById(a):d._activeNode();b&&(d._webAudio?b.gain.value=d._volume:b.muted=!1);return d},volume:function(a,d){var b=this;a=parseFloat(a);if(0<=a&&1>=a){b._volume=a;if(!b._loaded)return b.on("play",
function(){b.volume(a,d)}),b;var e=d?b._nodeById(d):b._activeNode();e&&(b._webAudio?e.gain.value=a:e.volume=a*l.volume());return b}return b._volume},loop:function(a){return"boolean"===typeof a?(this._loop=a,this):this._loop},sprite:function(a){return"object"===typeof a?(this._sprite=a,this):this._sprite},pos:function(a,d){var b=this;if(!b._loaded)return b.on("load",function(){b.pos(a)}),"number"===typeof a?b:b._pos||0;a=parseFloat(a);var e=d?b._nodeById(d):b._activeNode();if(e)return 0<=a?(b.pause(d),
e._pos=a,b.play(e._sprite,d),b):b._webAudio?e._pos+(h.currentTime-b._playStart):e.currentTime;if(0<=a)return b;for(e=0;e<b._audioNode.length;e++)if(b._audioNode[e].paused&&4===b._audioNode[e].readyState)return b._webAudio?b._audioNode[e]._pos:b._audioNode[e].currentTime},pos3d:function(a,d,b,e){var g=this;d="undefined"!==typeof d&&d?d:0;b="undefined"!==typeof b&&b?b:-.5;if(!g._loaded)return g.on("play",function(){g.pos3d(a,d,b,e)}),g;if(0<=a||0>a){if(g._webAudio){var c=e?g._nodeById(e):g._activeNode();
c&&(g._pos3d=[a,d,b],c.panner.setPosition(a,d,b),c.panner.panningModel=g._model||"HRTF")}}else return g._pos3d;return g},fade:function(a,d,b,e,g){var c=this,f=Math.abs(a-d),k=a>d?"down":"up",f=f/.01,h=b/f;if(!c._loaded)return c.on("load",function(){c.fade(a,d,b,e,g)}),c;c.volume(a,g);for(var m=1;m<=f;m++)(function(){var a=Math.round(1E3*(c._volume+("up"===k?.01:-.01)*m))/1E3;setTimeout(function(){c.volume(a,g);a===d&&e&&e()},h*m)})()},fadeIn:function(a,d,b){return this.volume(0).play().fade(0,a,d,
b)},fadeOut:function(a,d,b,e){var g=this;return g.fade(g._volume,a,d,function(){b&&b();g.pause(e);g.on("end")},e)},_nodeById:function(a){for(var d=this._audioNode[0],b=0;b<this._audioNode.length;b++)if(this._audioNode[b].id===a){d=this._audioNode[b];break}return d},_activeNode:function(){for(var a=null,d=0;d<this._audioNode.length;d++)if(!this._audioNode[d].paused){a=this._audioNode[d];break}this._drainPool();return a},_inactiveNode:function(a){for(var d=null,b=0;b<this._audioNode.length;b++)if(this._audioNode[b].paused&&
4===this._audioNode[b].readyState){a(this._audioNode[b]);d=!0;break}this._drainPool();if(!d){var e;if(this._webAudio)e=this._setupAudioNode(),a(e);else{this.load();e=this._audioNode[this._audioNode.length-1];var g=navigator.isCocoonJS?"canplaythrough":"loadedmetadata",c=function(){e.removeEventListener(g,c,!1);a(e)};e.addEventListener(g,c,!1)}}},_drainPool:function(){var a=0,d;for(d=0;d<this._audioNode.length;d++)this._audioNode[d].paused&&a++;for(d=this._audioNode.length-1;0<=d&&!(5>=a);d--)this._audioNode[d].paused&&
(this._webAudio&&this._audioNode[d].disconnect(0),a--,this._audioNode.splice(d,1))},_clearEndTimer:function(a){for(var d=-1,b=0;b<this._onendTimer.length;b++)if(this._onendTimer[b].id===a){d=b;break}if(a=this._onendTimer[d])clearTimeout(a.timer),this._onendTimer.splice(d,1)},_setupAudioNode:function(){var a=this._audioNode,d=this._audioNode.length;a[d]="undefined"===typeof h.createGain?h.createGainNode():h.createGain();a[d].gain.value=this._volume;a[d].paused=!0;a[d]._pos=0;a[d].readyState=4;a[d].connect(e);
a[d].panner=h.createPanner();a[d].panner.panningModel=this._model||"equalpower";a[d].panner.setPosition(this._pos3d[0],this._pos3d[1],this._pos3d[2]);a[d].panner.connect(a[d]);return a[d]},on:function(a,d){var b=this["_on"+a];if("function"===typeof d)b.push(d);else for(var e=0;e<b.length;e++)d?b[e].call(this,d):b[e].call(this);return this},off:function(a,d){var b=this["_on"+a];if(d)for(var e=0;e<b.length;e++){if(d===b[e]){b.splice(e,1);break}}else this["_on"+a]=[];return this},unload:function(){for(var a=
this._audioNode,d=0;d<this._audioNode.length;d++)a[d].paused||(this.stop(a[d].id),this.on("end",a[d].id)),this._webAudio?a[d].disconnect(0):a[d].src="";for(d=0;d<this._onendTimer.length;d++)clearTimeout(this._onendTimer[d].timer);a=l._howls.indexOf(this);null!==a&&0<=a&&l._howls.splice(a,1);delete c[this._src]}};if(f)var n=function(a,d){if(d in c)a._duration=c[d].duration,r(a);else if(/^data:[^;]+;base64,/.test(d)){for(var b=atob(d.split(",")[1]),e=new Uint8Array(b.length),g=0;g<b.length;++g)e[g]=
b.charCodeAt(g);q(e.buffer,a,d)}else{var f=new XMLHttpRequest;f.open("GET",d,!0);f.responseType="arraybuffer";f.onload=function(){q(f.response,a,d)};f.onerror=function(){a._webAudio&&(a._buffer=!0,a._webAudio=!1,a._audioNode=[],delete a._gainNode,delete c[d],a.load())};try{f.send()}catch(k){f.onerror()}}},q=function(a,d,b){h.decodeAudioData(a,function(a){a&&(c[b]=a,r(d,a))},function(a){d.on("loaderror",a)})},r=function(a,d){a._duration=d?d.duration:a._duration;0===Object.getOwnPropertyNames(a._sprite).length&&
(a._sprite={_default:[0,1E3*a._duration]});a._loaded||(a._loaded=!0,a.on("load"));a._autoplay&&a.play()},t=function(a,d,b){b=a._nodeById(b);b.bufferSource=h.createBufferSource();b.bufferSource.buffer=c[a._src];b.bufferSource.connect(b.panner);b.bufferSource.loop=d[0];d[0]&&(b.bufferSource.loopStart=d[1],b.bufferSource.loopEnd=d[1]+d[2]);b.bufferSource.playbackRate.value=a._rate};"function"===typeof define&&define.amd&&define(function(){return{Howler:l,Howl:p}});"undefined"!==typeof exports&&(exports.Howler=
l,exports.Howl=p);"undefined"!==typeof window&&(window.Howler=l,window.Howl=p)})();var __extends=this&&this.__extends||function(c,h){function f(){this.constructor=c}for(var b in h)h.hasOwnProperty(b)&&(c[b]=h[b]);c.prototype=null===h?Object.create(h):(f.prototype=h.prototype,new f)},core;
(function(c){var h=function(){function f(b){var a=this;this.canvasId=b;this.States={};this.HasFocus=!0;this.LastFrameTime=this.TimeDelta=0;this.StateDOMListeners=[];this.Canvas=document.getElementById(b);this.Context=this.Canvas.getContext("2d");this.RequestAnimationFrame=window.requestAnimationFrame.bind(window,this.OnUpdate.bind(this));window.onfocus=function(){return a.HasFocus=!0};window.onblur=function(){return a.HasFocus=!1}}f.prototype.AddState=function(b,a){this.States[b]=a};f.prototype.Play=
function(b){this.ActiveState&&this.CleanAfterState();if(this.ActiveState=this.States[b])this.ActiveState.Game=this,this.ActiveState.Start();else throw Error();};f.prototype.Start=function(){this.RequestAnimationFrame()};f.prototype.AddDOMEventListener=function(b,a,d){this.StateDOMListeners.push({element:b,type:a,listener:d});b.addEventListener(a,d)};f.prototype.RemoveDOMEventListener=function(b,a,d){for(var e=0,g=this.StateDOMListeners;e<g.length;e++){var f=g[e];if(f.element===b&&f.type===a&&f.listener===
d){c.RemoveElement(this.StateDOMListeners,f);b.removeEventListener(a,d);return}}throw Error("Couldn't find event listener.");};f.prototype.CleanAfterState=function(){audio.manager.StopAll();for(var b=this.StateDOMListeners.length-1;0<=b;--b){var a=this.StateDOMListeners[b];this.RemoveDOMEventListener(a.element,a.type,a.listener)}this.StateDOMListeners=[];this.ActiveState.Dispose&&this.ActiveState.Dispose()};f.prototype.OnUpdate=function(b){var a=b-this.LastFrameTime;if(!this.HasFocus&&50>a)return this.RequestAnimationFrame();
50<a&&(a=50);this.TimeDelta=a/1E3;this.ActiveState.Update(this.TimeDelta);this.ActiveState.Draw(this.Context);this.LastFrameTime=b;this.RequestAnimationFrame()};return f}();c.Game=h})(core||(core={}));
(function(c){var h=function(){function c(b,a){void 0===b&&(b=0);void 0===a&&(a=0);this.x=b;this.y=a}c.prototype.Set=function(b,a){this.x=b;this.y=a};c.prototype.Clone=function(b){return b?(b.x=this.x,b.y=this.y,b):new c(this.x,this.y)};c.prototype.toString=function(){return"[x: "+this.x+", y: "+this.y+"]"};return c}();c.Vector=h})(core||(core={}));
(function(c){(function(h){function f(a,b){void 0===a&&(a=0);void 0===b&&(b=0);return new c.Vector(a,b)}function b(a,b){return b?(b.x=a.x,b.y=a.y,b):f(a.x,a.y)}function a(a){return Math.sqrt(a.x*a.x+a.y*a.y)}h.Zero=new c.Vector;h.Tmp=new c.Vector;h.New=f;h.Clone=b;h.IsZero=function(a){return 0===a.x&&0===a.y};h.Add=function(a,b,g){g.x=a.x+b.x;g.y=a.y+b.y};h.Subtract=function(a,b,g){g.x=a.x-b.x;g.y=a.y-b.y};h.Multiply=function(a,b,g){g.x=a.x*b.x;g.y=a.y*b.y};h.Scale=function(a,b,g){void 0===g&&(g=a);
g.x=a.x*b;g.y=a.y*b};h.Length=a;h.LengthSqr=function(a){return a.x*a.x+a.y*a.y};h.Unit=function(d,b){void 0===b&&(b=d);var g=a(d);0<g&&(b.x=d.x/g,b.y=d.y/g)};h.Rotate=function(a,e,g){void 0===g&&(g=a);var c=Math.sin(e);e=Math.cos(e);a===g&&(a=b(a));g.x=a.x*e-a.y*c;g.y=a.x*c+a.y*e};h.Angle=function(a){return Math.atan2(a.y,a.x)};h.Invert=function(a,b){b.x=0<a.x?1/a.x:0;b.y=0<a.y?1/a.y:0};h.Dot=function(a,b){return a.x*b.x+a.y*b.y};h.Min=function(a,b,g){g.x=Math.min(a.x,b.x);g.y=Math.min(a.y,b.y)};
h.Max=function(a,b,g){g.x=Math.max(a.x,b.x);g.y=Math.max(a.y,b.y)}})(c.vector||(c.vector={}))})(core||(core={}));var vec=core.vector;
(function(c){var h=function(){function f(b,a,d,e){this.Position=c.vector.New(b,a);this.Size=c.vector.New(d,e);this.Anchor=c.vector.New(0,0);this.Scale=c.vector.New(1,1);this.Rotation=0;this.Alpha=1;this.Visible=!0}f.prototype.Draw=function(b){this.Visible&&(b.save(),b.globalAlpha*=this.Alpha,b.translate(this.Position.x,this.Position.y),b.scale(this.Scale.x,this.Scale.y),b.rotate(this.Rotation),c.vector.IsZero(this.Anchor)||b.translate(-this.Anchor.x*this.Size.x,-this.Anchor.y*this.Size.y),this.CachedObject?
this.DrawCache(b):this.DrawSelf(b),b.restore())};f.prototype.DrawCache=function(b){b.drawImage(this.CachedObject,0,0,this.Size.x,this.Size.y)};f.prototype.ToLocal=function(b,a){var d,e=c.vector.Tmp;a?(c.vector.Clone(b,a),d=a):d=c.vector.Clone(b);this.Parent&&this.Parent.ToLocal(b,d);c.vector.Subtract(d,this.Position,d);c.vector.Clone(this.Scale,e);c.vector.Invert(e,e);c.vector.Multiply(d,e,d);c.vector.Rotate(d,-this.Rotation,d);c.vector.Clone(this.Anchor,e);c.vector.Multiply(e,this.Size,e);c.vector.Add(d,
e,d);if(!a)return d};f.prototype.ToGlobal=function(b,a){var d=a?a:c.vector.New(),e=c.vector.Tmp;c.vector.Clone(this.Anchor,e);c.vector.Multiply(e,this.Size,e);c.vector.Subtract(b,e,d);c.vector.Rotate(d,this.Rotation);c.vector.Multiply(d,this.Scale,d);c.vector.Add(d,this.Position,d);this.Parent&&this.Parent.ToGlobal(d,d);if(!a)return d};f.prototype.IsPointInside=function(b,a,d){void 0===a&&(a=!0);void 0===d&&(d=c.vector.Zero);b=a?this.ToLocal(b):c.vector.Clone(b);a=b.y>-d.y&&b.y<this.Size.y+d.y;return b.x>
-d.x&&b.x<this.Size.x+d.x&&a};f.prototype.IsVisible=function(){return this.Parent?this.Visible&&this.Parent.IsVisible():this.Visible};f.prototype.RemoveFromParent=function(){this.Parent.RemoveChild(this)};f.prototype.Cache=function(b,a,d){void 0===b&&(b=1);var e;a&&(e=f.GlobalCache[a])?this.CachedObject=e:(e=this.CachedObject=document.createElement("canvas"),e.width=this.Size.x*b,e.height=this.Size.y*b,a&&(f.GlobalCache[a]=e),a=e.getContext("2d"),a.scale(b,b),d&&d(a),this.DrawSelf(a))};f.GlobalCache=
{};return f}();c.DisplayObject=h;h=function(c){function b(a,b,e,g){void 0===a&&(a=0);void 0===b&&(b=0);void 0===e&&(e=0);void 0===g&&(g=0);c.call(this,a,b,e,g);this.Children=[]}__extends(b,c);b.prototype.AddChild=function(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];for(b=0;b<a.length;b++){var e=a[b];if(e.Parent)throw Error("Child has parent");e.Parent=this;this.Children.push(e)}};b.prototype.RemoveChild=function(a){var b=this.Children.indexOf(a);if(0<=b)a.Parent=void 0,this.Children.splice(b,
1);else throw Error("Child doesn't exist in this layer");};b.prototype.DrawSelf=function(a){for(var b=0,e=this.Children;b<e.length;b++)e[b].Draw(a)};return b}(h);c.Layer=h})(core||(core={}));
(function(c){function h(a,b,g){var f=g.pageX,h=g.pageY,l=g.target.getBoundingClientRect(),f=new c.Vector(f-l.left,h-l.top);a.call(b,f,g)}function f(a,e,g){var c=0,f=0;if("touchend"!==g.type){var c=g.targetTouches[0].pageX,f=g.targetTouches[0].pageY,h=g.target.getBoundingClientRect();b.Set(c-h.left,f-h.top)}a.call(e,b.Clone(),g);g.preventDefault()}var b=new c.Vector;c.MakeMouseEventTranslator=function(a,b){return h.bind(null,a,b)};c.MakeTouchEventTranslator=function(a,b){return f.bind(null,a,b)};var a=
function(){function a(){this.OnDownListeners=[];this.OnUpListeners=[]}a.prototype.WhenPointerDown=function(a,b){this.OnDownListeners.push({object:a,action:b});return this};a.prototype.WhenPointerUp=function(a,b){this.OnUpListeners.push({object:a,action:b});return this};a.prototype.WhenPointerClick=function(a,b,d){for(var c=[],f=3;f<arguments.length;f++)c[f-3]=arguments[f];var h=0;this.OnDownListeners.push({object:a,action:function(){return h=Date.now()}});this.OnUpListeners.push({object:a,action:function(){450>
Date.now()-h&&b.apply(d,c)}});return this};a.prototype.OnPointerDown=function(a){this.HandleEvent(this.OnDownListeners,a)};a.prototype.OnPointerMove=function(a){};a.prototype.OnPointerUp=function(a){this.HandleEvent(this.OnUpListeners,a)};a.prototype.HandleEvent=function(a,b){for(var d=0;d<a.length;d++){var c=a[d],f=c.object,c=c.action;f.IsVisible()&&f.IsPointInside(b)&&c()}};a.prototype.Update=function(){};return a}();c.GenericInputController=a})(core||(core={}));
(function(c){function h(b){return b.slice(0)}c.RemoveElement=function(b,a){var d=b.indexOf(a);if(0<=d)return b.splice(d,1);throw Error();};c.TryRemoveElement=function(b,a){var d=b.indexOf(a);if(0<=d)return b.splice(d,1)};c.Last=function(b){return b[b.length-1]};c.Clone=h;c.ShuffleArray=function(b){b=h(b);for(var a=b.length-1;0<a;a--){var d=Math.floor(Math.random()*(a+1)),e=b[a];b[a]=b[d];b[d]=e}return b};c.IsPointInside=function(b,a){var d=c.vector.Tmp;c.vector.Clone(a.Anchor,d);c.vector.Multiply(d,
a.Size,d);c.vector.Subtract(a.Position,d,d);return b.x>d.x&&b.x<d.x+a.Size.x&&b.y>d.y&&b.y<a.Size.y+d.y};var f=function(){function b(a){void 0===a&&(a=60);this.ProbeNum=a;this.ProbeIdx=0;this.Probes=Array(a);for(var b=0;b<a;++b)this.Probes[b]=0}b.prototype.Update=function(a){this.Probes[this.ProbeIdx++%this.ProbeNum]=a};b.prototype.GetFPS=function(){return 1/this.GetAvgFrameTime()};b.prototype.GetAvgFrameTime=function(){for(var a=0,b=0;b<this.ProbeNum;++b)a+=this.Probes[b];return a/this.ProbeNum};
return b}();c.FPSMeter=f;f=function(){function b(){this.Callbacks=[]}b.prototype.Add=function(a,b){this.Callbacks.push([a,b,!1]);return this};b.prototype.AddOnce=function(a,b){this.Callbacks.push([a,b,!0]);return this};b.prototype.CallAll=function(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];for(b=this.Callbacks.length-1;0<=b;--b){var e=this.Callbacks[b],g=e[2];e[0].apply(e[1],a);g&&this.Callbacks.splice(b,1)}};return b}();c.CallbackSet=f})(core||(core={}));
(function(c){var h=function(){function b(a,b){this.Target=a;this.Manager=b;this.ElapsedTime=0;this.TweenedProperties=[];this.Duration=0;this.OnDoneCallbacks=new c.CallbackSet;this.OnStart=new c.CallbackSet;this.OnUpdateCallbacks=new c.CallbackSet;this.PlayReversed=this.IsLooping=this.IsDone=!1}b.prototype.Start=function(){var a=this.GetRoot();a.Manager&&(a.IsPlaying()&&a.Manager.StopTween(a),a.Manager.StartTween(a));for(;a;)a.IsDone=!1,a.ElapsedTime=0,a=a.Next;return this};b.prototype.Stop=function(a){void 0===
a&&(a=!0);var b=this.GetRoot();b.Manager&&b.IsPlaying()&&(a?b.Update(1E10):b.Manager.StopTween(b))};b.prototype.To=function(a,b,e){void 0===b&&(b=1);void 0===e&&(e=f.Linear);c.Assert(0<b,"Duration has be greater than 0.");this.TweenedProperties=[];for(var g in a)this.TweenedProperties.push({key:g,start:0,change:0,end:a[g]});this.Duration=b;this.Easeing=e;return this};b.prototype.WhenDone=function(a){this.OnDoneCallbacks.Add(a);return this};b.prototype.OnUpdate=function(a){this.OnUpdateCallbacks.Add(a);
return this};b.prototype.Then=function(a){void 0===a&&(a=this.Target);this.Next=a=new b(a,this.Manager);a.Prev=this;return a};b.prototype.Parallel=function(a,b){this.OnStart.Add(function(){if(this.Manager)b(this.Manager.New(a).Start());else throw Error();},this);return this};b.prototype.Delay=function(a){return this.To({},a)};b.prototype.Reverse=function(){for(var a=this;a;a=a.Prev)a.PlayReversed=!a.PlayReversed;return this};b.prototype.Loop=function(){this.IsLooping=!0;return this};b.prototype.Update=
function(a){for(var b=this;b;)if(0===b.ElapsedTime&&b.InitProperties(),b.ElapsedTime+=a,b.ElapsedTime<=b.Duration){b.UpdateProperties(b.ElapsedTime);break}else b.IsDone||(b.IsDone=!0,b.UpdateProperties(b.Duration),b.OnDoneCallbacks.CallAll(b.Target),!b.Manager||b.Next||b.IsLooping||b.Manager.StopTween(b.GetRoot()),b.IsLooping&&b.Start()),b=b.Next};b.prototype.GetRoot=function(){for(var a=this;a.Prev;)a=a.Prev;return a};b.prototype.IsPlaying=function(){if(this.Manager)return 0<=this.Manager.Tweens.indexOf(this.GetRoot());
throw Error();};b.prototype.UpdateProperties=function(a){for(var b=0,e=this.TweenedProperties;b<e.length;b++){var g=e[b];this.Target[g.key]=this.Easeing(a,g.start,g.change,this.Duration)}this.OnUpdateCallbacks.CallAll(this.Target,a/this.Duration)};b.prototype.InitProperties=function(){for(var a=0,b=this.TweenedProperties;a<b.length;a++){var e=b[a];if(this.PlayReversed){var g=e.start||this.Target[e.key];e.start=e.end;e.end=g}else e.start=this.Target[e.key];e.change=e.end-e.start}this.OnStart.CallAll()};
return b}();c.Tween=h;var f;(function(b){b.Linear=function(a,b,e,g){return e*a/g+b};b.CubicOut=function(a,b,e,g){a/=g;a--;return e*(a*a*a+1)+b};b.CubicIn=function(a,b,e,g){a/=g;return e*a*a*a+b};b.SinusoidalInOut=function(a,b,e,g){return-e/2*(Math.cos(Math.PI*a/g)-1)+b}})(f=c.easing||(c.easing={}));h=function(){function b(){this.Tweens=[]}b.prototype.New=function(a){return new c.Tween(a,this)};b.prototype.StartTween=function(a){this.Tweens.push(a)};b.prototype.StopTween=function(a){c.RemoveElement(this.Tweens,
a)};b.prototype.TweenPlaying=function(){return this.Tweens.some(function(a){return a.IsPlaying()})};b.prototype.Update=function(a){for(var b=0,e=this.Tweens;b<e.length;b++)e[b].Update(a)};b.prototype.StopAll=function(a){void 0===a&&(a=!0);if(a)for(a=this.Tweens.length-1;0<=a;--a)this.Tweens[a].Stop(!0);else this.Tweens=[]};return b}();c.TweenManager=h})(core||(core={}));
(function(c){var h=function(){function b(a,b,e,g,c,f){void 0===g&&(g=0);void 0===c&&(c=1);this.Callback=a;this.Ctx=b;this.Delay=e;this.Interval=g;this.CallLimit=c;this.Args=f;this.CallCount=this.ElapsedTime=0}b.prototype.Update=function(a){this.ElapsedTime+=a;if(this.ElapsedTime>this.Delay){if(0<this.CallLimit&&this.CallCount>this.CallLimit-1)return!0;this.ElapsedTime-this.Delay>this.Interval*this.CallCount&&(this.CallCount+=1,this.Callback.apply(this.Ctx,[this.CallCount].concat(this.Args)))}return!1};
b.prototype.Stop=function(){if(this.Manager)this.Manager.Remove(this);else throw Error("This timer doesn't have manager.");};return b}();c.Timer=h;var f=function(){function b(){this.Timers=[];this.ThrottledCallback=[]}b.prototype.Delay=function(a,b,e){for(var g=[],c=3;c<arguments.length;c++)g[c-3]=arguments[c];g=new h(b,e,a,void 0,1,g);g.Manager=this;this.Timers.push(g);return g};b.prototype.Repeat=function(a,b,e,g,c){void 0===g&&(g=0);void 0===c&&(c=0);for(var f=[],l=5;l<arguments.length;l++)f[l-
5]=arguments[l];f=new h(b,e,c,a,g,f);f.Manager=this;this.Timers.push(f);return f};b.prototype.Throttle=function(a,b,e){for(var g=this,f=[],h=3;h<arguments.length;h++)f[h-3]=arguments[h];0>this.ThrottledCallback.indexOf(b)&&(b.apply(e,f),this.ThrottledCallback.push(b),this.Delay(a,function(){return c.RemoveElement(g.ThrottledCallback,b)}))};b.prototype.Update=function(a){for(var b=this.Timers.length-1;0<=b;--b)this.Timers[b].Update(a)&&this.Timers.splice(b,1)};b.prototype.Count=function(){return this.Timers.length};
b.prototype.RemoveAll=function(){for(var a=0,b=this.Timers;a<b.length;a++)b[a].Manager=void 0;this.Timers=[]};b.prototype.Remove=function(a){c.RemoveElement(this.Timers,a);a.Manager=void 0};return b}();c.TimersManager=f})(core||(core={}));
(function(c){(function(h){var f=c.vector;h.Clamp=function(b,a,d){return Math.max(Math.min(b,d),a)};h.DistanceP2L=function(b,a,d){var e=f.New(),c=f.New();f.Subtract(d,a,e);f.Subtract(b,a,c);d=f.Dot(c,e)/f.LengthSqr(e);f.Scale(e,d);f.Add(e,a,e);f.Subtract(b,e,e);return f.Length(e)}})(c.math||(c.math={}))})(core||(core={}));var state;
(function(c){var h=function(){function c(){this.DefaultSize=new core.Vector(64,64)}c.prototype.Start=function(){var b=this;this.Stage=new core.Layer(0,0,this.DefaultSize.x,this.DefaultSize.y);this.Tweens=new core.TweenManager;this.Timers=new core.TimersManager;this.FPSMeter=new core.FPSMeter(60);this.FPSText=new gfx.AAText(10,10,"FPS");this.FPSText.SetSize(10);this.FPSText.Visible=!1;this.Game.AddDOMEventListener(window,"resize",function(a){return b.OnResize()})};c.prototype.Update=function(b){this.Timers.Update(b);
this.Tweens.Update(b);this.FPSText.Visible&&(this.FPSMeter.Update(b),this.FPSText.SetText(this.FPSMeter.GetFPS().toFixed(1)))};c.prototype.Draw=function(b){b.clearRect(0,0,b.canvas.width,b.canvas.height);this.Stage.Draw(b);this.FPSText.Draw(b)};c.prototype.OnPointerDown=function(b){this.InputController.OnPointerDown(b)};c.prototype.OnPointerMove=function(b){this.InputController.OnPointerMove(b)};c.prototype.OnPointerUp=function(b){this.InputController.OnPointerUp(b)};c.prototype.OnKeyDown=function(b){};
c.prototype.OnKeyUp=function(b){};c.prototype.OnResize=function(){var b=Math.min(window.innerWidth/this.DefaultSize.x,window.innerHeight/this.DefaultSize.y);this.Stage.Scale.Set(b,b);this.Stage.Size.Set(this.DefaultSize.x,this.DefaultSize.y);var a=Math.floor(this.Stage.Size.x*b);this.Game.Canvas.width!==a&&(this.Game.Canvas.width=a);b=Math.floor(this.Stage.Size.y*b);this.Game.Canvas.height!==b&&(this.Game.Canvas.height=b);this.Game.Context.imageSmoothingEnabled=!1;this.Game.Context.mozImageSmoothingEnabled=
!1;this.Game.Context.webkitImageSmoothingEnabled=!1;this.Game.Context.msImageSmoothingEnabled=!1};c.prototype.ShowFps=function(){this.FPSText.Visible=!0};c.prototype.DimScreen=function(b,a){void 0===b&&(b=!1);void 0===a&&(a=2);b&&(this.Stage.Alpha=1-this.Stage.Alpha);return this.Tweens.New(this.Stage).To({Alpha:b?1:0},a).Start()};c.prototype.ShakeScreen=function(b,a){void 0===a&&(a=3);return this.Tweens.New(this.Stage.Position).OnUpdate(function(b,e){e=Math.sin(e*Math.PI);b.Set(core.Random(-a,a)*
e|0,core.Random(-a,a)*e|0)}).Delay(b).Then().To({x:0,y:0},.01).Start()};c.prototype.ListenForMouseInput=function(){if(!this.InputController)throw Error();this.Game.AddDOMEventListener(this.Game.Canvas,"mousemove",core.MakeMouseEventTranslator(this.OnPointerMove,this));this.Game.AddDOMEventListener(this.Game.Canvas,"mousedown",core.MakeMouseEventTranslator(this.OnPointerDown,this));this.Game.AddDOMEventListener(this.Game.Canvas,"mouseup",core.MakeMouseEventTranslator(this.OnPointerUp,this))};c.prototype.ListenForTouchInput=
function(){if(!this.InputController)throw Error();this.Game.AddDOMEventListener(this.Game.Canvas,"touchmove",core.MakeTouchEventTranslator(this.OnPointerMove,this));this.Game.AddDOMEventListener(this.Game.Canvas,"touchstart",core.MakeTouchEventTranslator(this.OnPointerDown,this));this.Game.AddDOMEventListener(this.Game.Canvas,"touchend",core.MakeTouchEventTranslator(this.OnPointerUp,this))};c.prototype.ListenForKeyboard=function(){var b=this;if(!this.InputController)throw Error();this.Game.AddDOMEventListener(window,
"keydown",function(a){b.OnKeyDown(a.keyCode);a.preventDefault()});this.Game.AddDOMEventListener(window,"keyup",function(a){b.OnKeyUp(a.keyCode);a.preventDefault()})};return c}();c.AbstractState=h})(state||(state={}));var gfx;
(function(c){var h=function(){function c(b,a,d){void 0===d&&(d="white");this.Font=b;this.Size=a;this.Color=d;this.CacheMap={};this.DotSizePx=a/b.Char.Height;this.CharWidthPx=b.Char.Width*this.DotSizePx;this.Cache=document.createElement("canvas");this.Cache.width=Object.keys(b.Letter).length*Math.ceil(this.CharWidthPx+this.DotSizePx);this.Cache.height=a;console.log("FontCache Size",this.Size,"DotPx",this.DotSizePx,"Color",this.Color);this.Render()}c.prototype.DrawLetter=function(b,a,d,e,c,f){void 0===
d&&(d=0);void 0===e&&(e=0);void 0===c&&(c=1);void 0===f&&(f=c);b.drawImage(this.Cache,this.CacheMap[a],0,this.CharWidthPx,this.Size,d,e,this.CharWidthPx*c,this.Size*f)};c.prototype.Render=function(){var b=this.Cache.getContext("2d"),a=0;b.fillStyle=this.Color;for(var d in this.Font.Letter){this.RenderLetter(b,d);this.CacheMap[d]=a;var e=Math.ceil(this.CharWidthPx+this.DotSizePx),a=a+e;b.translate(e,0)}};c.prototype.RenderLetter=function(b,a){for(var d=this.Font,e=this.DotSizePx,c=0;c<d.Char.Width;++c)for(var f=
0;f<d.Char.Height;++f)d.Letter[a][f*d.Char.Width+c]&&b.fillRect(c*e,f*e,e,e)};return c}();c.FontChache=h})(gfx||(gfx={}));
(function(c){c.PixelFont={Char:{Width:3,Height:5},Letter:{"+":[0,0,0,0,1,0,1,1,1,0,1,0,0,0,0],"-":[0,0,0,0,0,0,1,1,1,0,0,0,0,0,0],_:[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],".":[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],",":[0,0,0,0,0,0,0,0,0,0,1,0,1,0,0],":":[0,0,0,0,1,0,0,0,0,0,1,0,0,0,0],"?":[1,1,0,0,0,1,0,1,1,0,0,0,0,1,0],"!":[0,1,0,0,1,0,0,1,0,0,0,0,0,1,0],"\u2665":[1,0,1,1,1,1,1,1,1,0,1,0,0,0,0],0:[1,1,1,1,0,1,1,0,1,1,0,1,1,1,1],1:[0,1,0,1,1,0,0,1,0,0,1,0,0,1,0],2:[1,1,1,0,0,1,1,1,1,1,0,0,1,1,1],3:[1,1,1,0,0,1,
0,1,1,0,0,1,1,1,1],4:[1,0,1,1,0,1,1,1,1,0,0,1,0,0,1],5:[1,1,1,1,0,0,1,1,1,0,0,1,1,1,0],6:[0,1,1,1,0,0,1,1,1,1,0,1,1,1,1],7:[1,1,1,0,0,1,0,1,0,0,1,0,0,1,0],8:[1,1,1,1,0,1,1,1,1,1,0,1,1,1,1],9:[1,1,1,1,0,1,1,1,1,0,0,1,1,1,0],A:[0,1,0,1,0,1,1,1,1,1,0,1,1,0,1],B:[1,1,0,1,0,1,1,1,0,1,0,1,1,1,0],C:[1,1,1,1,0,0,1,0,0,1,0,0,1,1,1],D:[1,1,0,1,0,1,1,0,1,1,0,1,1,1,0],E:[1,1,1,1,0,0,1,1,0,1,0,0,1,1,1],F:[1,1,1,1,0,0,1,1,0,1,0,0,1,0,0],G:[1,1,1,1,0,0,1,0,1,1,0,1,1,1,1],H:[1,0,1,1,0,1,1,1,1,1,0,1,1,0,1],I:[0,1,
0,0,1,0,0,1,0,0,1,0,0,1,0],J:[1,1,1,0,1,0,0,1,0,0,1,0,1,0,0],K:[1,0,1,1,0,1,1,1,0,1,0,1,1,0,1],L:[1,0,0,1,0,0,1,0,0,1,0,0,1,1,1],N:[0,0,1,1,0,1,1,1,1,1,0,1,1,0,0],M:[1,0,1,1,1,1,1,0,1,1,0,1,1,0,1],O:[1,1,1,1,0,1,1,0,1,1,0,1,1,1,1],P:[1,1,1,1,0,1,1,1,1,1,0,0,1,0,0],Q:[1,1,1,1,0,1,1,0,1,1,1,0,0,0,1],R:[1,1,0,1,0,1,1,1,0,1,0,1,1,0,1],S:[1,1,1,1,0,0,1,1,0,0,0,1,1,1,1],T:[1,1,1,0,1,0,0,1,0,0,1,0,0,1,0],U:[1,0,1,1,0,1,1,0,1,1,0,1,1,1,1],W:[1,0,1,1,0,1,1,0,1,1,1,1,1,0,1],V:[1,0,1,1,0,1,1,0,1,1,0,1,0,1,0],
X:[1,0,1,1,0,1,0,1,0,1,0,1,1,0,1],Y:[1,0,1,1,0,1,1,0,1,0,1,0,0,1,0],Z:[1,1,1,0,0,1,0,1,1,1,0,0,1,1,1]},Cache:{}}})(gfx||(gfx={}));
(function(c){var h=function(f){function b(a,b,e,g){void 0===e&&(e="");void 0===g&&(g={Size:20,Color:"white",Font:c.PixelFont});f.call(this,a,b,0,0);this.Text=e;this.Style=g;this.SetColor(g.Color);this.SetSize(g.Size)}__extends(b,f);b.prototype.SetColor=function(a){this.FontRenderer=this.Style.Font.Cache[a]?this.Style.Font.Cache[a]:this.Style.Font.Cache[a]=new c.FontChache(this.Style.Font,20,a)};b.prototype.SetText=function(a){this.Text=a;this.UpdateSize()};b.prototype.SetSize=function(a){this.Style.Size=
a;this.DotSizePx=a/this.Style.Font.Char.Height;this.CharWidthPx=this.Style.Font.Char.Width*this.DotSizePx;this.UpdateSize()};b.prototype.DrawSelf=function(a){for(var b=this.Style.Size/this.FontRenderer.Size,e=0;e<this.Text.length;++e){var c=this.Text[e];" "!==c&&this.FontRenderer.DrawLetter(a,c,0,0,b);a.translate(this.CharWidthPx+this.DotSizePx,0)}};b.prototype.UpdateSize=function(){this.Size.x=(this.CharWidthPx+this.DotSizePx)*this.Text.length-this.DotSizePx;this.Size.y=this.Style.Size};return b}(core.DisplayObject);
c.Text=h;h=function(c){function b(){c.apply(this,arguments)}__extends(b,c);b.prototype.Draw=function(a){if(this.Visible){var b=this.Style.Size/this.FontRenderer.Size,e=this.Position,c=e.x,e=e.y,c=c-this.Size.x*this.Anchor.x*this.Scale.x,e=e-this.Size.y*this.Anchor.y*this.Scale.y,f=a.globalAlpha;a.globalAlpha*=this.Alpha;for(var h=0;h<this.Text.length;++h){var l=this.Text[h];" "!==l&&this.FontRenderer.DrawLetter(a,l,c,e,b*this.Scale.x,b*this.Scale.y);c+=(this.CharWidthPx+this.DotSizePx)*this.Scale.x}a.globalAlpha=
f}};b.prototype.Cache=function(){throw Error("Use gfx.Text if you want cache");};return b}(h);c.AAText=h})(gfx||(gfx={}));(function(c){c.ImageLoader={load:function(c){return new Promise(function(f,b){var a=new Image;a.onload=function(){return f(a)};a.onerror=function(a){return b(a)};a.src=c})}}})(core||(core={}));
(function(c){var h=function(){function f(b,a,d,e){this.Position=new c.Vector(b,a);this.Size=new c.Vector(d,e)}f.prototype.Clone=function(b){b=b||new f(0,0,0,0);this.Position.Clone(b.Position);this.Size.Clone(b.Size);return b};return f}();c.Rect=h})(core||(core={}));
(function(c){var h=function(c){function b(a,d,e,g){c.call(this,a,d,0,0);if(this.Image=b.ImageCache[e])this.SourceRect=g?g.Clone():new core.Rect(0,0,this.Image.width,this.Image.height),this.SourceRect.Size.Clone(this.Size);else throw Error("Couldn't find "+e+" in cache");}__extends(b,c);b.prototype.DrawSelf=function(a){this.Image?a.drawImage(this.Image,this.SourceRect.Position.x,this.SourceRect.Position.y,this.SourceRect.Size.x,this.SourceRect.Size.y,0,0,this.Size.x,this.Size.y):(a.fillStyle="black",
a.strokeStyle="red",a.rect(0,0,this.Size.x,this.Size.y),a.fill(),a.stroke())};b.Load=function(){for(var a=[],d=0;d<arguments.length;d++)a[d-0]=arguments[d];return Promise.all(a.map(function(a){var d=a[0];return core.ImageLoader.load(a[1]).then(function(a){return b.ImageCache[d]=a})}))};b.ImageCache={};return b}(core.DisplayObject);c.Sprite=h})(gfx||(gfx={}));(function(c){c.Assert=function(c,f){if(!c)throw Error("Assertion failed. "+(f||""));}})(core||(core={}));
(function(c){var h=function(){function f(b,a,d){void 0===d&&(d=new core.Vector);this.ImageId=b;this.CellSize=a;this.Offset=d;this.ImageSize=new core.Vector;this.GridSize=new core.Vector;if(a=c.Sprite.ImageCache[b])this.ImageSize.Set(a.width,a.height),this.UpdateGridSize();else throw Error("Tileset with given id "+b+" doesn't exsit.");}f.prototype.GetSprite=function(b){core.Assert(1<=b,"Sprites id have to be greater than 0.");return new c.Sprite(0,0,this.ImageId,this.GetSourceRect(b))};f.prototype.GetSourceRect=
function(b){if(!(1>b)){--b;var a=b%this.GridSize.x,d=Math.floor(b/this.GridSize.x);core.Assert(a<this.GridSize.x&&d<this.GridSize.y,"Sprite id:"+b+" is out of bounds.");return new core.Rect(a*this.CellSize.x+this.Offset.x,d*this.CellSize.y+this.Offset.y,this.CellSize.x,this.CellSize.y)}};f.prototype.UpdateGridSize=function(){var b=this.ImageSize.x/this.CellSize.x,a=this.ImageSize.y/this.CellSize.y;core.Assert(0===b%1,"Width of image doesn't match grid size.");core.Assert(0===a%1,"Height of image doesn't match grid size.");
this.GridSize.Set(b,a)};return f}();c.SpriteSheet=h})(gfx||(gfx={}));
(function(c){var h=function(c){function b(a,b,e,g,k){void 0===k&&(k=e.CellSize);c.call(this,a,b);this.TileSet=e;this.Data=g;this.CellSize=k;this.GridSize=new core.Vector;this.BuildLayer()}__extends(b,c);b.prototype.BuildLayer=function(){var a=this;core.Assert(0<this.Data.length,"Layer data can't be null.");core.Assert(this.Data.every(function(b){return b.length===a.Data[0].length}),"Each row has to have the same length.");this.Data.forEach(function(b,e){b.forEach(function(b,d){if(0!=b){var c=a.TileSet.GetSprite(b);
c.Position.Set(d*a.CellSize.x,e*a.CellSize.y);a.AddChild(c)}})});this.GridSize.Set(this.Data[0].length,this.Data.length);core.vector.Multiply(this.GridSize,this.CellSize,this.Size)};return b}(core.Layer);c.TileLayer=h})(gfx||(gfx={}));var game;
(function(c){c.assets={HERO_FACE_UP:1,HERO_FACE_LEFT:2,HERO_FACE_RIGHT:3,HERO_FALLING:4,HERO_LANDING:[5,6,7,8],FLOATING_TILE_FRAMES:[1,2,3,4,5],SMALL_SHADOW:31,COW_BELL:[32],HEART:[35,36],ATTACK_BONUS:34,SWORD:[71,72,73,74,75,76,77,78],PLAYER_TORCH:[81,82,83,84,85,86,87,88,89],GREEN_TORCH_FRAMES:[41,42,43,44],HEART_FRAME:37,HEART_FILL:38,RED_DEMON_FRAMES:[51,52],BLUE_DEMON_FRAMES:[53,54,55,56],GREEN_DEMON_FRAMES:[57,58,59,60],PURPLE_DEMON_FRAMES:[244,245,246,247],DARK_DEMON_FRAMES:[261,261,261,261,
261,261,262,263,264,265,266,267,268,269],FIGHT_DEMON_HEALTHBAR:117,FIGHT_DEMON_MOUTH:{RED:[91,94],BLUE:[124,127],GREEN:[154,157],PURPLE:[184,187],DARK:[214,217]},FIGHT_LIGHT_CONE:97,MAIN_MENU_SCENE:[121,151,181,211],INTRO_SCENE:[281,284,311,314,341,344,371,374,401,404,431,434,461,464]}})(game||(game={}));
(function(c){c=c.data||(c.data={});c=c.layer||(c.layer={});c.ground=[[0,0,0,0,12,0,0,0,0],[0,0,0,0,11,0,0,0,0],[0,0,0,0,11,0,0,0,0],[1,0,1,0,11,0,1,0,1],[1,0,1,0,11,0,1,0,1],[1,1,1,1,1,1,1,1,1],[0,0,0,0,1,0,0,0,0],[1,0,1,0,1,0,1,0,1],[1,0,1,0,1,0,1,0,1],[1,1,1,1,1,1,1,1,1],[0,0,0,1,0,0,12,12,1],[0,0,0,1,1,0,12,0,0],[0,0,0,0,1,12,12,0,0],[0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0]];c.actors=[[0,0,0,2,6,2,0,0,0],[0,0,0,2,0,2,0,0,0],[0,0,0,2,0,2,0,0,0],[5,0,5,2,0,2,5,0,5],[0,0,0,2,0,2,0,0,0],[0,0,0,0,0,
0,0,0,0],[0,0,0,0,0,0,0,0,0],[4,0,4,0,0,0,4,0,4],[0,2,0,0,0,0,0,2,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,2,0,0,0,7],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,3,0,0,0,0],[0,0,0,0,0,0,0,0,0]]})(game||(game={}));
(function(c){var h=function(){function b(a,b,e,c){void 0===c&&(c=!1);this.Frames=a;this.Timeline=b;this.Duration=e;this.Loop=c;this.Progress=0;this.Name="unnamed";core.Assert(0<this.Duration,"Duration has to be greater than 0.");core.Assert(0<this.Frames.length,"Frames can't be empty.");core.Assert(this.Timeline.every(function(a){a=a[0];return 0<=a&&1>=a}),"Timeline point has to be in range [0, 1].");core.Assert(this.Timeline.every(function(a,b,d){a=a[0];return b<d.length-1?a<d[b+1][0]:1>a}),"Point on timeline has to be in ascending order.")}
b.prototype.Update=function(a){this.Progress+=a/this.Duration;this.Loop&&1<this.Progress&&--this.Progress;this.Progress=core.math.Clamp(this.Progress,0,1)};b.prototype.GetFrame=function(a){void 0===a&&(a=this.Progress);for(var b=this.Timeline.length-1;0<=b;--b){var e=this.Timeline[b],c=e[1];if(e[0]<=a)return this.Frames[c]}};b.prototype.IsDone=function(){return 1===this.Progress};b.prototype.Reset=function(){this.Progress=0};return b}(),f=function(){function b(){this.Animations={}}b.prototype.AddAnimation=
function(a,b,e){core.Assert(void 0===this.Animations[a],"Can't override animation "+a);return e instanceof c.SpriteSheet?this.AddAnimation_S(a,b,e):this.AddAnimation_D(a,b,e)};b.prototype.Play=function(a){core.Assert(void 0!==this.Animations[a],"Animation doesn't exist");this.ActiveAnimation&&this.ActiveAnimation.IsDone()&&this.ActiveAnimation.Reset();this.ActiveAnimation=this.Animations[a]};b.prototype.RestartAnimation=function(){this.ActiveAnimation&&this.ActiveAnimation.Reset()};b.prototype.Update=
function(a){this.ActiveAnimation&&this.ActiveAnimation.Update(a)};b.prototype.GetFrame=function(){if(this.ActiveAnimation)return this.ActiveAnimation.GetFrame();throw Error("There is no active frame.");};b.prototype.IsAnimationDone=function(a){return this.Animations[a].IsDone()};b.prototype.AddAnimation_S=function(a,b,e){var c=b.filter(function(a,e){return b.indexOf(a)==e}).map(function(a){return e.GetSprite(a)});b=b.map(function(a){return b.indexOf(a)});return this.AddAnimation_D(a,b,c)};b.prototype.AddAnimation_D=
function(a,b,e){var c=b.map(function(a,e){return[e/b.length,a]});e=this.Animations[a]=new h(e,c,1);e.Name=a;return e};return b}();c.Animator=f})(gfx||(gfx={}));(function(c){var h=function(f){function b(a,b,e,g,h){void 0===h&&(h=new c.Animator);f.call(this,a,b,e,g);this.Animator=h}__extends(b,f);b.prototype.DrawSelf=function(a){this.Animator.GetFrame().Draw(a)};b.prototype.Update=function(a){this.Animator.Update(a)};return b}(core.DisplayObject);c.AnimatedSprite=h})(gfx||(gfx={}));
(function(c){var h=function(c){function b(a,b,e,g){c.call(this,a,b,e,g);this.IsActive=!0;this.GridPosition=new core.Vector;this.Timer=new core.TimersManager;this.Tween=new core.TweenManager;this.EnableSubpixelMovement=!1}__extends(b,c);b.prototype.Update=function(a){this.Timer.Update(a);this.Tween.Update(a);this.EnableSubpixelMovement||this.Position.Set(Math.floor(this.Position.x),Math.floor(this.Position.y))};return b}(core.DisplayObject);c.Actor=h;h=function(c){function b(){c.apply(this,arguments);
this.Animator=new gfx.Animator;this.Sprite=new gfx.AnimatedSprite(0,0,this.Size.x,this.Size.y,this.Animator)}__extends(b,c);b.prototype.Update=function(a){c.prototype.Update.call(this,a);this.Sprite.Update(a);this.EnableSubpixelMovement||this.Sprite.Position.Set(Math.floor(this.Sprite.Position.x),Math.floor(this.Sprite.Position.y))};b.prototype.DrawSelf=function(a){this.Sprite.Draw(a)};return b}(h);c.AnimatedActor=h})(game||(game={}));
(function(c){(c.features||(c.features={})).IsMobileBrowser=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase())})(core||(core={}));var audio;
(function(c){(function(){function c(){this.Sounds={};this.Volume=1}c.prototype.AddSound=function(b,a,d){void 0===d&&(d=1);var e=[];d=core.features.IsMobileBrowser?0:d;for(var c=0;c<d;++c){var f=jsfxr(a),h=new Audio;h.src=f;e.push(h)}this.Sounds[b]={index:0,pool:e}};c.prototype.Play=function(b,a){void 0===a&&(a=1);var d=this.Sounds[b];if(d=d.pool[d.index++%d.pool.length])d.volume=a*this.Volume,d.play()};return c})();var h=function(){function c(){this.Sounds={};this.PlayingSounds=[]}c.prototype.GetVolume=
function(){return Howler.volume()};c.prototype.SetVolume=function(b){Howler.volume(b)};c.prototype.Play=function(b,a,d){var c=this;void 0===a&&(a=1);void 0===d&&(d=!1);var g=this.Sounds[b];if(g)g.loop(d),g.volume(a),g.play(),-1===this.PlayingSounds.indexOf(g)&&(this.PlayingSounds.push(g),g.onend=function(){core.TryRemoveElement(c.PlayingSounds,g)});else throw Error("Sound with name "+b+" doesn't exist in this manager.");};c.prototype.StopAll=function(){this.PlayingSounds.forEach(function(b){return b.stop()});
this.PlayingSounds.length=0};c.prototype.FadeOutAll=function(b){void 0===b&&(b=2);this.PlayingSounds.forEach(function(a){return a.fade(1,0,b)})};c.prototype.LoadSound=function(b,a){var d=this;return(new Promise(function(b,d){var c=new Howl({urls:a,onload:function(){return b(c)},onloaderror:function(a){return d(a)}})})).then(function(a){return d.Sounds[b]=a})};c.prototype.LoadAll=function(b){var a=this;return Promise.all(b.map(function(b){return a.LoadSound(b[0],b[1])}))};return c}();c.manager=new h})(audio||
(audio={}));
(function(c){var h=function(f){function b(a,b,e){f.call(this,a,b,24,24);this.Face="left";this.Animator.AddAnimation("left",[c.assets.HERO_FACE_LEFT],e);this.Animator.AddAnimation("right",[c.assets.HERO_FACE_RIGHT],e);this.Animator.AddAnimation("up",[c.assets.HERO_FACE_UP],e);this.Animator.AddAnimation("falling",[c.assets.HERO_FALLING],e);this.Animator.AddAnimation("landing",c.assets.HERO_LANDING,e).Duration=.7;this.Shadow=e.GetSprite(c.assets.SMALL_SHADOW);this.Animator.Play("left");this.SetupDustParticles();this.Alpha=
0;this.IsActive=!1}__extends(b,f);b.prototype.DrawSelf=function(a){this.Shadow.Draw(a);this.DustParticles.Draw(a);this.Sprite.Draw(a)};b.prototype.PlayJump=function(a){var b=this;this.UpdateFace(a);return this.Tween.New(this.Position).To({x:a.x,y:a.y},.5,core.easing.SinusoidalInOut).Parallel(this.Sprite.Position,function(a){return a.To({y:b.Sprite.Position.y-10},.25,core.easing.CubicOut).Then().To({y:b.Sprite.Position.y},.25)}).Start()};b.prototype.PlayDead=function(a){var b=this;void 0===a&&(a=10);
return this.Tween.New(this).To({Alpha:0},2).Parallel(this.Position,function(c){return c.To({y:b.Position.y+a},2,core.easing.CubicOut)}).Start()};b.prototype.FallFromHeaven=function(){var a=this,b=this.ToLocal(new core.Vector(GAME.Canvas.width/2,0));this.Sprite.Position.Set(b.x-12,b.y-24);this.Animator.Play("falling");this.Alpha=1;return this.Tween.New(this.Sprite.Position).To({x:0,y:0},1,core.easing.CubicIn).WhenDone(function(){c.context.PlayState.ShakeScreen(.5);a.EmitParticles();audio.manager.Play("demon-hit")}).Then().Delay(.5).WhenDone(function(){a.IsActive=
!0;a.Timer.Delay(1,function(){return a.Animator.Play("landing")});a.Timer.Delay(2,function(){return a.Animator.Play("left")})}).Start()};b.prototype.UpdateFace=function(a){this.Face=0>a.y-this.Position.y?"up":0<a.x-this.Position.x?"right":"left";this.Animator.Play(this.Face)};b.prototype.EmitParticles=function(){var a=this;this.DustParticles.Visible=!0;this.DustParticles.Children.forEach(function(b){b.Position.Set(12,15);b.Size.Set(1,1);var c=new core.Vector(0,1);core.vector.Rotate(c,core.Random(-Math.PI,
Math.PI));core.vector.Scale(c,8);core.vector.Add(b.Position,c,c);b.Alpha=0;a.Tween.New(b.Position).To({x:c.x,y:c.y-3},1).OnUpdate(function(){b.Position.Set(b.Position.x|0,b.Position.y|0)}).Parallel(b,function(a){return a.To({Alpha:1},.5).Then().To({Alpha:0},.5)}).Start()})};b.prototype.SetupDustParticles=function(){this.DustParticles=new core.Layer;this.DustParticles.Alpha=.2;this.DustParticles.Visible=!1;for(var a=0;40>a;++a){var b=new gfx.Rectangle(0,0,2,2,{fillStyle:"#c0c0c0"});this.DustParticles.AddChild(b)}};
return b}(c.AnimatedActor);c.AHero=h})(game||(game={}));
(function(c){var h=function(){function f(){this.KilledDemons=[];this.AquiredItems=[];this.LifesLeft=3}f.prototype.IsOnlyBossAlive=function(){return 4===this.KilledDemons.length};f.prototype.AllDemonsKilled=function(){return 5===this.KilledDemons.length};f.prototype.PlayerHas=function(b){return-1!==this.AquiredItems.indexOf(b)};f.prototype.DemonNeedsLight=function(b){return-1!==["Dark","Purple","Green"].indexOf(b)};f.prototype.Reset=function(){console.log("Reseting context.");c.context=new f};return f}();
c.context=new h})(game||(game={}));
(function(c){var h=function(c){function b(a,b,e,g,h){void 0===h&&(h={fillStyle:"red"});c.call(this,a,b,e,g);this.Style=h}__extends(b,c);b.prototype.DrawSelf=function(a){this.Style.compositeOperation&&(a.globalCompositeOperation=this.Style.compositeOperation);this.Style.fillStyle&&(a.fillStyle=this.Style.fillStyle,a.fillRect(0,0,this.Size.x,this.Size.y));this.Style.strokeStyle&&(a.lineWidth=this.Style.lineWidth||1,a.strokeStyle=this.Style.strokeStyle,a.strokeRect(0,0,this.Size.x,this.Size.y))};return b}(core.DisplayObject);
c.Rectangle=h})(gfx||(gfx={}));(function(c){c.Random=function(c,f){if(f<c)throw Error();return c+Math.random()*(f-c)};c.TossCoin=function(c,f){return.5<Math.random()?c:f};c.RandomElement=function(c){return c[Math.random()*c.length|0]}})(core||(core={}));
(function(c){var h=function(f){function b(a,b,e){f.call(this,a,b,24,48);a=new gfx.SpriteSheet(e,new core.Vector(24,48),new core.Vector(0,24));this.Animator.AddAnimation("collapse",c.assets.FLOATING_TILE_FRAMES,a);this.Animator.AddAnimation("raise",c.assets.FLOATING_TILE_FRAMES.slice(0).reverse(),a);this.Animator.AddAnimation("idle",[c.assets.FLOATING_TILE_FRAMES[0]],a);this.Animator.Play("idle");this.SetupDustParticles()}__extends(b,f);b.prototype.Collapse=function(){var a=this.Sprite.Position;this.IsActive=
!1;audio.manager.Play("floor-collapsing",.5);this.Animator.Play("collapse");this.Tween.New(a).To({y:a.y+15},1).OnUpdate(function(){return a.Set(a.x|0,a.y|0)}).Parallel(this.Sprite,function(a){return a.To({Alpha:0},1)}).Parallel(null,function(a){return a.Delay(.25).WhenDone(function(){c.context.PlayState.ShakeScreen(.5)})}).Then().To({y:a.y},.01).Start();this.EmitParticles()};b.prototype.Raise=function(){var a=this,b=this.Sprite.Position;b.y+=15;this.Animator.Play("raise");this.Tween.New(b).To({y:b.y-
15},1).OnUpdate(function(){return b.Set(b.x|0,b.y|0)}).Parallel(this.Sprite,function(a){return a.To({Alpha:1},1)}).Start().WhenDone(function(){return a.Animator.Play("idle")})};b.prototype.RaiseWhenVisible=function(){var a=this;this.Visible=!1;this.Sprite.Alpha=0;var b=this.Timer.Repeat(0,function(){a.Visible&&(a.Raise(),b.Stop())})};b.prototype.DrawSelf=function(a){this.Sprite.Draw(a);this.DustPartices.Draw(a)};b.prototype.EmitParticles=function(){var a=this;this.DustPartices.Visible=!0;this.DustPartices.Children.forEach(function(b){b.Position.Set(12+
core.Random(-6,6),20+core.Random(-2,2));b.Size.Set(1,1);var c=new core.Vector(0,1);core.vector.Rotate(c,core.Random(-Math.PI,Math.PI));core.vector.Scale(c,8);core.vector.Add(b.Position,c,c);b.Alpha=0;a.Tween.New(b.Position).Delay(.5).Then().To({x:c.x,y:c.y-15},4).OnUpdate(function(){b.Position.Set(b.Position.x|0,b.Position.y|0)}).Parallel(b,function(a){return a.To({Alpha:1},1).Then().To({Alpha:0},3)}).Start()})};b.prototype.SetupDustParticles=function(){this.DustPartices=new core.Layer;this.DustPartices.Alpha=
.2;this.DustPartices.Visible=!1;for(var a=0;40>a;++a){var b=new gfx.Rectangle(0,0,2,2,{fillStyle:"#c0c0c0"});this.DustPartices.AddChild(b)}};return b}(c.AnimatedActor);c.AFloatingTile=h})(game||(game={}));(function(c){var h=function(f){function b(a,b,e){f.call(this,a,b,e.CellSize.x,e.CellSize.y);this.Animator.AddAnimation("idle",c.assets.GREEN_TORCH_FRAMES,e).Loop=!0;this.Animator.Play("idle")}__extends(b,f);return b}(c.AnimatedActor);c.ATorch=h})(game||(game={}));
(function(c){var h=function(c){function b(a,b,e){c.call(this,a,b,0,0);this.Label=new gfx.AAText(0,0,e);this.Label.SetSize(5);this.Label.Size.Clone(this.Size)}__extends(b,c);b.prototype.DrawSelf=function(a){this.Label.Draw(a)};return b}(c.Actor);c.AText=h})(game||(game={}));
(function(c){var h=function(b){function a(a,c,g,f,h){b.call(this,a,c,24,48);this.Name=h;this.Animator.AddAnimation("idle",g.map(function(a,b){return b}),g.map(function(a){a=f.GetSprite(a);a.SourceRect.Size.Set(24,48);a.Size.Set(24,48);return a})).Loop=!0;this.Animator.Play("idle");this.Sprite.Position.y-=17}__extends(a,b);return a}(c.AnimatedActor);c.ADemon=h;var f=function(b){function a(a,e,g){b.call(this,a,e,c.assets.RED_DEMON_FRAMES,g,"Red")}__extends(a,b);return a}(h);c.ARedDemon=f;f=function(b){function a(a,
e,g){b.call(this,a,e,c.assets.BLUE_DEMON_FRAMES,g,"Blue");this.Animator.Animations.idle.Duration=2}__extends(a,b);return a}(h);c.ABlueDemon=f;f=function(b){function a(a,e,g){b.call(this,a,e,c.assets.GREEN_DEMON_FRAMES,g,"Green")}__extends(a,b);return a}(h);c.AGreenDemon=f;f=function(b){function a(a,e,g){b.call(this,a,e,c.assets.PURPLE_DEMON_FRAMES,g,"Purple")}__extends(a,b);return a}(h);c.APurpleDemon=f;h=function(b){function a(a,e,g){b.call(this,a,e,c.assets.DARK_DEMON_FRAMES,g,"Dark");this.Animator.Animations.idle.Duration=
2}__extends(a,b);return a}(h);c.ADarkDemon=h})(game||(game={}));
(function(c){var h=function(b){function a(a,e,g,f,h){b.call(this,a,e,24,24);this.Name=h;this.Animator.AddAnimation("idle",g,f).Loop=!0;this.Animator.Play("idle");this.Shadow=f.GetSprite(c.assets.SMALL_SHADOW);this.Tween.New(this.Sprite.Position).To({y:-4},1,core.easing.SinusoidalInOut).Then().To({y:.5},1,core.easing.SinusoidalInOut).Loop().Start()}__extends(a,b);a.prototype.DrawSelf=function(a){this.Shadow.Draw(a);this.Sprite.Draw(a)};a.prototype.ShowInGlory=function(){this.Tween.StopAll(!1);return this.Tween.New(this.Sprite.Position).To({y:-18},
1,core.easing.CubicOut).Start()};return a}(c.AnimatedActor);c.AItem=h;var f=function(b){function a(a,e,g){b.call(this,a,e,c.assets.HEART,g,"Life")}__extends(a,b);a.prototype.Execute=function(){4>c.context.LifesLeft&&(c.context.LifesLeft+=1)};a.prototype.GetDescription=function(){return["one more","chance"]};return a}(h);c.ALifeBonus=f;f=function(b){function a(a,e,g){b.call(this,a,e,c.assets.SWORD,g,"Sword")}__extends(a,b);a.prototype.Execute=function(){};a.prototype.GetDescription=function(){return["attack",
"increased"]};return a}(h);c.AAttackBonus=f;f=function(b){function a(a,e,g){b.call(this,a,e,c.assets.PLAYER_TORCH,g,"Light")}__extends(a,b);a.prototype.Execute=function(){};a.prototype.GetDescription=function(){return["coisy","fire"]};return a}(h);c.ALightBonus=f;h=function(b){function a(a,e,g){b.call(this,a,e,c.assets.COW_BELL,g,"Secret")}__extends(a,b);a.prototype.Execute=function(){};a.prototype.GetDescription=function(){return["there is no","cow level"]};return a}(h);c.ASecret=h})(game||(game=
{}));
(function(c){var h=["Red","Blue"],f=["Green","Purple"],b=["Sword","Life"],a=["Punch","Light"],d=["Dark"],e=new core.Vector,g=function(){var c=core.ShuffleArray,e=c(f),g=c(a),k=c(h),m=c(b);return d.concat(c([e[0],g[0]]).concat(c([e[1],g[1]])).concat(c([k[0],m[0]]).concat(c([k[1],m[1]]))))}(),k=function(a){function b(d,e){a.call(this,d,e);this.GroundLayer=new core.Layer;this.GroundLookup=[];this.ActorLayer=new core.Layer;this.Demons=[];this.Items=[];this.Timer=new core.TimersManager;c.context.Purgatory=this;
this.SpriteSheet=new gfx.SpriteSheet("spritesheet",new core.Vector(24,24));this.Spawner=new m(this.SpriteSheet);this.BuildTileLayers();this.Size.Set(c.data.layer.ground[0].length,c.data.layer.ground.length);core.vector.Scale(this.Size,24,this.Size);this.Timer.Delay(0,function(){return audio.manager.Play("temple",.7,!0)})}__extends(b,a);b.prototype.Update=function(a){for(var b=0,c=this.GroundLayer.Children;b<c.length;b++){var d=c[b];d.Update(a);this.ToGlobal(d.Position,e);d.Visible=-240<e.x&&e.x<GAME.Canvas.width&&
-240<e.y&&e.y<GAME.Canvas.height}b=0;for(c=this.ActorLayer.Children;b<c.length;b++)d=c[b],d.Update(a),this.ToGlobal(d.Position,e),d.Visible=-240<e.x&&e.x<GAME.Canvas.width&&-240<e.y&&e.y<GAME.Canvas.height;this.Timer.Update(a)};b.prototype.MovePlayer=function(a){this.Timer.Throttle(.18,this.DoMovePlayer,this,a)};b.prototype.DoMovePlayer=function(a){var b=this;if(c.context.PlayState.CameraTweens.TweenPlaying())c.context.PlayState.CameraTweens.Update(2);else if(this.Player.IsActive||this.Player.Tween.Update(1),
this.Player.IsActive&&!this.Player.Tween.TweenPlaying()){var d=this.Player.GridPosition.Clone();switch(a){case 0:--d.x;break;case 2:--d.y;break;case 1:d.x+=1}a=this.GridPosToLayerPos(d);if(this.CanMoveTo(d)){var e=this.Player.GridPosition;this.GroundLookup[e.y][e.x].Collapse();d.Clone(this.Player.GridPosition);this.Player.PlayJump(a).WhenDone(function(){return b.TileAction(b.Player.GridPosition)})}else this.Player.IsActive=!1,this.Player.PlayJump(a).WhenDone(function(){return b.PlayerDied()})}};b.prototype.GridPosToLayerPos=
function(a,b){void 0===b&&(b=new core.Vector);core.vector.Multiply(a,this.SpriteSheet.CellSize,b);return b};b.prototype.PlayerDied=function(){this.Timer.Delay(1,function(){return c.context.PlayState.DimScreen(!1,1)});this.Player.PlayDead().WhenDone(function(){--c.context.LifesLeft;GAME.Play("you-died")})};b.prototype.TileAction=function(a){for(var b=this,d=function(d){d.GridPosition.x==a.x&&d.GridPosition.y==a.y&&(e.Player.IsActive=!1,c.context.PlayState.Timers.Delay(.7,function(){b.Timer.Delay(0,
function(){return audio.manager.Play("monster-fight")});c.context.PlayState.BlinkScreen(1);c.context.PlayState.ShakeScreen(1).WhenDone(function(){c.context.PlayState.BeginFigthMode(d.Name)})}))},e=this,g=0,f=this.Demons;g<f.length;g++)d(f[g]);for(var d=function(d){d.GridPosition.x==a.x&&d.GridPosition.y==a.y&&(h.Player.IsActive=!1,c.context.AquiredItems.push(d.Name),d.Execute(),d.ShowInGlory(),audio.manager.FadeOutAll(.5),audio.manager.Play("item-aquired"),h.ShowText(d.GetDescription()[0],"white",
15),h.ShowText(d.GetDescription()[1],"white",21).WhenDone(function(){var a=b.Player.GridPosition;b.GroundLookup[a.y][a.x].Collapse();d.Visible=!1;c.context.PlayState.DimScreen();b.Player.PlayDead(30).WhenDone(function(){c.context.PlayState.RestartPurgatory()})}))},h=this,g=0,f=this.Items;g<f.length;g++)d(f[g]);return!1};b.prototype.ShowText=function(a,b,d){void 0===b&&(b="white");void 0===d&&(d=0);var e=new core.Vector(GAME.Canvas.width/2,GAME.Canvas.height/2),e=this.ToLocal(e),g=new c.AText(0,e.y+
d,a.toUpperCase());g.Label.SetColor(b);g.Anchor.Set(.5,.5);g.Position.x=this.ToLocal(new core.Vector(GAME.Canvas.width,0)).x+20;this.ActorLayer.AddChild(g);return this.Player.Tween.New(g.Position).To({x:e.x},1,core.easing.SinusoidalInOut).Then().Delay(2).Then().To({x:this.ToLocal(core.vector.Zero).x-20},1,core.easing.SinusoidalInOut).Start().WhenDone(function(){g.RemoveFromParent()})};b.prototype.CanMoveTo=function(a){return 0>a.y||a.y>this.GroundLookup.length-1?!1:(a=this.GroundLookup[a.y][a.x])?
a.IsActive:!1};b.prototype.BuildTileLayers=function(){var a=this;c.data.layer.ground.forEach(function(b,d){a.GroundLookup.push([]);b.forEach(function(b,e){var g;switch(b){case 0:return;case 1:g=new c.AFloatingTile(0,0,a.SpriteSheet.ImageId);break;case 11:if(c.context.IsOnlyBossAlive())g=new c.AFloatingTile(0,0,a.SpriteSheet.ImageId),g.RaiseWhenVisible();else return;break;case 12:g=new c.AFloatingTile(0,0,a.SpriteSheet.ImageId);g.Alpha=0;break;default:throw Error("tile not mapped.");}g.GridPosition.Set(e,
d);core.vector.Multiply(g.GridPosition,a.SpriteSheet.CellSize,g.Position);a.GroundLookup[d][e]=g;a.GroundLayer.AddChild(g)})});var b=0;c.data.layer.actors.forEach(function(d,e){d.forEach(function(d,g){var f;switch(d){case 0:return;case 2:f=new c.ATorch(0,0,a.SpriteSheet);break;case 3:f=a.Player=new c.AHero(0,0,a.SpriteSheet);a.Timer.Delay(.8,function(){var b=a.Player.FallFromHeaven();c.context.IsOnlyBossAlive()&&b.WhenDone(function(){a.CameraShowPathToFinalBoss()})});break;case 4:case 5:case 6:f=
a.Spawner.SpawnActor(b++);if(f instanceof c.ADemon)a.Demons.push(f);else if(f instanceof c.AItem)a.Items.push(f);else return;break;case 7:if(c.context.PlayerHas("Secret"))return;f=new c.ASecret(0,0,a.SpriteSheet);a.Items.push(f);break;default:console.error("actor not mapped. ("+d+")");return}f.GridPosition.Set(g,e);core.vector.Multiply(f.GridPosition,a.SpriteSheet.CellSize,f.Position);a.ActorLayer.AddChild(f)})});this.AddChild(this.GroundLayer);this.AddChild(this.ActorLayer)};b.prototype.CameraShowPathToFinalBoss=
function(){var a=this,b=this.Demons.filter(function(a){return"Dark"===a.Name})[0];this.Player.IsActive=!1;c.context.PlayState.MoveCameraTo(b.Position,10).WhenDone(function(){c.context.PlayState.DimScreen(!1,1)}).Then().Delay(1).WhenDone(function(){c.context.PlayState.DimScreen(!0,1);a.Player.IsActive=!0})};return b}(core.Layer);c.Purgatory=k;var m=function(){function e(g){this.Sheet=g;this.DemonNames=h.concat(f).concat(d);this.ItemNames=b.concat(a);this.AliveDemons=this.DemonNames.filter(function(a){return-1===
c.context.KilledDemons.indexOf(a)});this.LeftItems=this.ItemNames.filter(function(a){return-1===c.context.AquiredItems.indexOf(a)})}e.prototype.SpawnActor=function(a){a=g[a];if(this.ActorExist(a))switch(a){case "Red":return new c.ARedDemon(0,0,this.Sheet);case "Blue":return new c.ABlueDemon(0,0,this.Sheet);case "Green":return new c.AGreenDemon(0,0,this.Sheet);case "Purple":return new c.APurpleDemon(0,0,this.Sheet);case "Dark":return new c.ADarkDemon(0,0,this.Sheet);case "Life":return new c.ALifeBonus(0,
0,this.Sheet);case "Sword":return new c.AAttackBonus(0,0,this.Sheet);case "Light":return new c.ALightBonus(0,0,this.Sheet)}};e.prototype.ActorExist=function(a){return-1!==this.AliveDemons.indexOf(a)||-1!==this.LeftItems.indexOf(a)};return e}()})(game||(game={}));
(function(c){var h=function(c){function b(a,b,e,g){var h=this;void 0===g&&(g="white");c.call(this,a,b,e[0].length,e.length);this.Pixels=e;this.Color=g;this.FloatPosition=new core.Vector;core.Assert(0<e.length,"Pixels can't be null.");this.Position.Clone(this.FloatPosition);this.Size.Set(e[0].length,e.length);this.Timer.Repeat(0,function(){return h.FloatPosition.Clone(h.Position)});this.Cache()}__extends(b,c);b.prototype.DrawSelf=function(a){a.fillStyle=this.Color;for(var b=0;b<this.Pixels.length;++b)for(var c=
this.Pixels[b],g=0;g<c.length;++g)0!==c[g]&&a.fillRect(g,b,1,1)};b.prototype.GetBottomRight=function(a){void 0===a&&(a=new core.Vector);vec.Add(this.Position,this.Size,a);return a};b.prototype.Blink=function(a,b){var c=this;void 0===a&&(a=1);void 0===b&&(b=.05);var g=a/b|0;this.Timer.Repeat(b,function(a){c.Visible=a==g?!0:!c.Visible},void 0,g)};return b}(c.Actor);c.ATooth=h;(function(c){function b(b,c){if(b.Size.x*b.Size.y>c.Size.x*c.Size.y){var d=b;b=c;c=d}d=a;vec.Subtract(b.Position,c.Position,
d);for(var f=0;f<b.Size.y;++f)if(c.Pixels[f+d.y])for(var h=0;h<b.Size.x;++h){var p=c.Pixels[f+d.y][h+d.x];if(void 0!=p&&0!=b.Pixels[f][h]&&0!=p)return!0}return!1}var a=new core.Vector,d=new core.Vector;c.PixelPerfectCollision=b;c.Collide=function(c,g){var f=c.GetBottomRight(a),h=c.Position,l=g.GetBottomRight(d),p=g.Position;return h.x>l.x||f.x<p.x||h.y>l.y||f.y<p.y?!1:b(c,g)};c.player=[[0,0,0,1],[1,0,1,0],[0,1,0,0],[1,0,1,0]];c.SpikeLike=function(a,b){void 0===b&&(b=Math.floor(a/2)+1);core.Assert(1===
a%2,"only odd width");core.Assert(0<b);core.Assert(2*b-1>=a);for(var c=Math.floor(a/2)+1,d=[],f=0;f<c;++f){for(var h=[],n=0;n<a/2-1;++n)h[n]=a/2-1-n<f?1:0;h[Math.floor(a/2)]=1;for(var n=Math.floor(a/2)+1,q=0;n<a;++n,++q)h[n]=h[Math.floor(a/2)-1-q];d.push(h)}c=[d[0]];for(h=1;;++h)for(f=1;f<d.length;++f)if(c.splice(f*h,0,d[f].slice(0)),c.length===b)return c};c.CircleLike=function(a,b){core.Assert(1===a%2,"only odd width");core.Assert(0<b);for(var c=a/2,d=[],f=0;f<b;++f){for(var h=[],n=0;n<a;++n){var q=
n-c,r=f-c;h[n]=Math.sqrt(q*q+r*r)<c?1:0}d.push(h)}return d};c.SlashLike=function(a,b,c,d){void 0===c&&(c=1);void 0===d&&(d=!0);core.Assert(0<b);for(var f=[],h=0;h<b;++h){for(var n=[],q=0;q<a;++q)n[q]=q<h*c?1:0;d||n.reverse();f.push(n)}return f}})(c.tooth||(c.tooth={}))})(game||(game={}));
(function(c){var h=function(c){function b(a,b,e,g){c.call(this,a,b,64,64);core.Assert(2==e.length);a=e.map(function(a){return g.GetSprite(a)});a.forEach(function(a){a.SourceRect.Size.Set(64,64);a.Size.Set(64,64)});this.Animator.AddAnimation("idle",[0],a);this.Animator.AddAnimation("hurt",[1],a);this.Animator.Play("idle")}__extends(b,c);b.prototype.Hurt=function(){var a=this;this.Animator.Play("hurt");this.Timer.Delay(.3,function(){return a.Animator.Play("idle")})};return b}(c.AnimatedActor);c.ADemonFace=
h})(game||(game={}));
(function(c){var h=function(){function b(a,b,c,g){void 0===g&&(g=1);this.r=a;this.g=b;this.b=c;this.a=g;this.r=Math.round(a);this.g=Math.round(b);this.b=Math.round(c)}b.prototype.ToHSV=function(){var a=this.r,b=this.g,c=this.b,g=Math.max(a,b,c),h=Math.min(a,b,c),m=g-h,l;switch(g){case h:l=0;break;case a:l=(b-c+m*(b<c?6:0))/(6*m);break;case b:l=(c-a+2*m)/(6*m);break;case c:l=(a-b+4*m)/(6*m)}return new f(l,0===g?0:m/g,g/255,this.a)};b.prototype.toString=function(){return"rgba("+this.r+", "+this.g+", "+
this.b+", "+this.a+")"};return b}();c.RgbColor=h;var f=function(){function b(a,b,c,g){void 0===g&&(g=1);this.h=a;this.s=b;this.v=c;this.a=g}b.prototype.ToRGB=function(){var a=this.h,b=this.s,c=this.v,g=Math.floor(6*a),f=6*a-g,a=c*(1-b),m=c*(1-f*b),b=c*(1-(1-f)*b),l,p,n;switch(g%6){case 0:l=c;p=b;n=a;break;case 1:l=m;p=c;n=a;break;case 2:l=a;p=c;n=b;break;case 3:l=a;p=m;n=c;break;case 4:l=b;p=a;n=c;break;case 5:l=c,p=a,n=m}return new h(255*l,255*p,255*n,this.a)};b.prototype.toString=function(){return"hsva("+
this.h+", "+this.s+", "+this.v+", "+this.a+")"};return b}();c.HsvColor=f})(core||(core={}));
(function(c){var h=function(){function f(b){this.Value=b;this.OnChange=new c.CallbackSet}f.prototype.Get=function(){return this.Value};f.prototype.Set=function(b){var a=this.Value;this.Value=b;this.OnChange.CallAll(b,a)};f.prototype.toString=function(){return this.Value.toString()};return f}();c.ObservableProperty=h;h=function(c){function b(){c.apply(this,arguments)}__extends(b,c);b.prototype.Increment=function(a){void 0===a&&(a=1);this.Set(this.Value+a)};return b}(h);c.ObservableNumber=h})(core||
(core={}));
(function(c){var h=function(){function a(b,c,d,e){void 0===e&&(e="white");this.Upper=b;this.Lower=c;this.Gap=d;this.Color=e;core.Assert(b.length===c.length);this.Lower=c.map(function(a){return a?a.slice(0):a});this.Upper=b.map(function(a){return a?a.slice(0):a});this.LastX=this.Gap*(this.Lower.length-1);this.Upper.forEach(function(a){if(a)return a.reverse()})}a.prototype.SpawnAll=function(a,b){var d=this,e=[];this.Upper.forEach(function(b,g){b&&e.push(new c.ATooth(a.x+g*d.Gap,a.y,b,d.Color))});this.Lower.forEach(function(a,
g){if(a){var f=new c.ATooth(b.x+g*d.Gap,b.y,a,d.Color);f.FloatPosition.y-=f.Size.y;e.push(f)}});return e};return a}();c.TeethGenertor=h;var h=c.tooth.SpikeLike(15,25),f=c.tooth.SpikeLike(15,35),b=c.tooth.SpikeLike(19,25),a=c.tooth.SpikeLike(19,32),d=c.tooth.SpikeLike(19,16),e=c.tooth.SpikeLike(25,13),g=c.tooth.CircleLike(15,16),k=c.tooth.CircleLike(15,38),m=c.tooth.SlashLike(15,29,.25,!1),l=c.tooth.SlashLike(15,29,.25);c.theeth={Red:{upper:[h,void 0,b,void 0,d,void 0],lower:[void 0,a,void 0,f,d,f],
gap:30},Blue:{upper:[e,e,e,d,void 0,e,e,e,d,e],lower:[e,e,e,d,e,e,e,e,d,void 0],gap:25},Green:{upper:[void 0,k,void 0,g,void 0,k],lower:[k,void 0,k,g,k,void 0],gap:25,color:"#ac3232"},Purple:{upper:[m,void 0,m,void 0,l,void 0],lower:[l,void 0,l,void 0,m,void 0],gap:13},Dark:{upper:[m,void 0,m,void 0,h,void 0,h,d,d],lower:[l,void 0,l,void 0,void 0,f,void 0,d,d],gap:15}}})(game||(game={}));
(function(c){var h=function(c){function b(a,b,e,g){void 0===g&&(g={fillStyle:"red"});c.call(this,a,b,2*e,2*e);this.Style=g;this.Angle={Start:0,Stop:2*Math.PI};if(0>=e)throw Error();}__extends(b,c);b.prototype.DrawSelf=function(a){var b=this.Size.x/2;a.beginPath();a.arc(b,b,b-1,this.Angle.Start,this.Angle.Stop);this.Style.compositeOperation&&(a.globalCompositeOperation=this.Style.compositeOperation);this.Style.lineWidth&&(a.lineWidth=this.Style.lineWidth);this.Style.fillStyle&&(a.fillStyle=this.Style.fillStyle,
a.fill());this.Style.strokeStyle&&(a.strokeStyle=this.Style.strokeStyle,a.stroke())};return b}(core.DisplayObject);c.Circle=h})(gfx||(gfx={}));
(function(c){var h=function(a){return a.Set(Math.floor(a.x),Math.floor(a.y))},f=function(d){function e(a,e,f,h){var p=this;d.call(this,a,e,64,64);this.DemonName=h;this.Mouth=new core.Layer(5,15,54,45);this.Face=new core.Layer(0,0,64,64);this.Teeth=new core.Layer;this.TeethVelocity=new core.Vector(-10,0);this.Player=new c.ATooth(5,20,c.tooth.player);this.PlayerVelocity=new core.Vector(0,0);this.CanFlap=!0;this.LockFlap=!1;this.Gravity=new core.Vector(0,80);this.DemonHealthBar=new b(5,2,54,2,new core.RgbColor(174,
50,50,1));this.TimeScale=1;this.Timers=new core.TimersManager;this.Tween=new core.TweenManager;this.BloodTween=new core.TweenManager;this.BloodParticles=new core.Layer;a=new gfx.SpriteSheet("spritesheet",new core.Vector(24,24));this.DemonFace=new c.ADemonFace(0,0,c.assets.FIGHT_DEMON_MOUTH[h.toUpperCase()],a);this.DemonHealthBarBg=a.GetSprite(c.assets.FIGHT_DEMON_HEALTHBAR);this.DemonHealthBarBg.SourceRect.Size.Set(64,7);this.DemonHealthBarBg.Size.Set(64,7);f.SpawnAll(new core.Vector(this.Size.x/
2,0),new core.Vector(this.Size.x/2,45)).forEach(function(a){a.Visible=a.Position.x<p.Mouth.Size.x+10;p.Teeth.AddChild(a)});this.ToothRestartX=f.LastX;this.Mouth.AddChild(this.Teeth,this.Player,this.BloodParticles);this.Face.AddChild(this.DemonFace);c.context.DemonNeedsLight(this.DemonName)&&(c.context.PlayerHas("Light")||this.ActiveLightCone(a));this.SetupBloodParticles(20);this.BloodParticles.Visible=!1;this.DemonHealthBar.Progress.OnChange.Add(function(a){0>=a&&p.DemonSlayed()});this.TimeScale=
0;this.Timers.Delay(0,function(){return audio.manager.Play("fight-scene",.7,!0)});c.context.PlayState.DimScreen(!0,2).WhenDone(function(){return p.TimeScale=1})}__extends(e,d);e.prototype.Update=function(a){a*=this.TimeScale;this.Timers.Update(a);this.BloodTween.Update(a);this.Tween.Update(a);this.DemonFace.Update(a);var b=this.CheckCollision();this.IntegrateVelocity(a);b||(0>this.Player.FloatPosition.y?this.DemonTakeDamage(!0):this.Player.FloatPosition.y>this.Mouth.Size.y-this.Player.Size.y&&this.DemonTakeDamage(!1));
this.Player.FloatPosition.y=core.math.Clamp(this.Player.FloatPosition.y,0,this.Mouth.Size.y-this.Player.Size.y);this.Player.Update(a)};e.prototype.DrawSelf=function(a){this.Mouth.Draw(a);this.Face.Draw(a);this.DemonHealthBarBg.Draw(a);this.DemonHealthBar.Draw(a)};e.prototype.Flap=function(){!this.LockFlap&&this.CanFlap&&this.Player.IsActive&&(this.PlayerVelocity.y=-40,this.CanFlap=!1)};e.prototype.Flip=function(){this.CanFlap=!0};e.prototype.DemonTakeDamage=function(a){var b=this;if(this.Player.IsActive){this.DemonFace.Hurt();
audio.manager.Play("demon-hit");this.PlayerVelocity.y=40*(a?.45:-1);c.context.PlayState.ShakeScreen(.3,3);this.LockFlap=!0;this.Timers.Delay(.25,function(){return b.LockFlap=!1});var d=new core.Vector;a?this.Player.Position.Clone(d):vec.Add(this.Player.Position,this.Player.Size,d);this.EmitBloodParicles(d,a);c.context.PlayerHas("Sword")?this.DemonHealthBar.Progress.Increment(-.101):this.DemonHealthBar.Progress.Increment(-.05)}};e.prototype.PlayerTakeDamage=function(){this.Player.IsActive&&(audio.manager.FadeOutAll(),
this.Player.IsActive=!1,this.TeethVelocity.Set(0,0),this.Gravity.Set(0,0),this.PlayerVelocity.Set(0,0),this.Tween.New(this.Mouth).Delay(2).Then().To({Alpha:0},1.5).Start(),this.Tween.New(this.Face).Delay(2).Then().To({Alpha:0},2).Start().WhenDone(function(){--c.context.LifesLeft;GAME.Play("you-died")}))};e.prototype.DemonSlayed=function(){var a=this;this.Player.IsActive&&(c.context.KilledDemons.push(this.DemonName),audio.manager.FadeOutAll(),this.Player.IsActive=!1,this.TeethVelocity.Set(0,0),this.Gravity.Set(0,
0),this.PlayerVelocity.Set(0,0),this.Tween.New(this.Mouth).Delay(2).Then().To({Alpha:0},1.5).Parallel(this.Mouth.Position,function(b){return b.To({y:a.Mouth.Position.y+50},2,core.easing.CubicIn).OnUpdate(h)}).Start(),this.Tween.New(this.Face).Delay(2).WhenDone(function(){return c.context.PlayState.ShakeScreen(2,4)}).Then().To({Alpha:0},2).Parallel(this.Face.Position,function(b){return b.To({y:a.Face.Position.y+50},2,core.easing.CubicIn).OnUpdate(h)}).Start().WhenDone(function(){GAME.Play("demon-slayed")}))};
e.prototype.CheckCollision=function(){for(var a=0,b=this.Teeth.Children;a<b.length;a++){var d=b[a];if(c.tooth.Collide(this.Player,d))return d.IsActive&&(d.IsActive=!1,d.Blink(2,.1),this.PlayerTakeDamage()),!0}return!1};e.prototype.IntegrateVelocity=function(a){var b=new core.Vector;vec.Scale(this.TeethVelocity,a,b);for(var c=0,d=this.Teeth.Children;c<d.length;c++){var e=d[c];vec.Add(e.FloatPosition,b,e.FloatPosition);e.Update(a);-20>e.Position.x?(e.FloatPosition.x=this.ToothRestartX,e.IsActive=!0,
e.Visible=!1):e.Position.x>=this.Mouth.Size.x&&e.Position.x<this.Mouth.Size.x+10&&(e.Visible=!0)}vec.Scale(this.Gravity,a,b);vec.Add(this.PlayerVelocity,b,this.PlayerVelocity);vec.Scale(this.PlayerVelocity,a,b);vec.Add(this.Player.FloatPosition,b,this.Player.FloatPosition)};e.prototype.SetupBloodParticles=function(a){for(var b=0;b<a;++b)this.BloodParticles.AddChild(new gfx.Rectangle(0,0,1,1,{fillStyle:"rgba(255, 0, 0, 0.5)"}))};e.prototype.EmitBloodParicles=function(a,b){var c=this;this.BloodTween.StopAll(!1);
this.BloodParticles.Visible=!0;for(var d=0,e=this.BloodParticles.Children;d<e.length;d++){var f=e[d];f.Position.Set(0,0);f.Alpha=1;var q=core.Random(5,10),r=q/10*1;this.BloodTween.New(f.Position).To({y:b?q:-q,x:core.Random(-5,5)},r/2,core.easing.CubicOut).OnUpdate(h).Then().OnUpdate(h).To({y:0},r/2,core.easing.CubicIn).Start()}d=1.5*this.TeethVelocity.x;this.BloodParticles.Position.Set(a.x,a.y);this.BloodTween.New(this.BloodParticles.Position).OnUpdate(h).To({x:a.x+d},1).Start().WhenDone(function(){return c.BloodParticles.Visible=
!1})};e.prototype.ActiveLightCone=function(b){var d=this;b=b.GetSprite(c.assets.FIGHT_LIGHT_CONE);b.Size.Set(40,40);b.SourceRect.Size.Set(40,40);this.LightCone=new a(0,0,b);this.LightCone.Position.x=this.Player.Position.x-this.LightCone.Size.x/2+2;this.Timers.Repeat(0,function(){d.LightCone.Position.y=d.Player.Position.y-d.LightCone.Size.x/2+2});this.Mouth.AddChild(this.LightCone)};return e}(core.DisplayObject);c.FightMode=f;var b=function(a){function b(c,e,f,h,p){var n=this;a.call(this,c,e,f,h);
this.Progress=new core.ObservableNumber(1);this.Fill=new gfx.Rectangle(0,0,f,h,{fillStyle:p.toString()});this.Progress.OnChange.Add(function(a){a=core.math.Clamp(a,0,1);n.Fill.Size.x=a*f|0})}__extends(b,a);b.prototype.DrawSelf=function(a){this.Fill.Draw(a)};return b}(core.DisplayObject),a=function(a){function b(c,e,f){a.call(this,c,e,f.Size.x,f.Size.y);this.Shape=f}__extends(b,a);b.prototype.DrawSelf=function(a){a.globalCompositeOperation="destination-in";this.Shape.Draw(a)};return b}(core.DisplayObject)})(game||
(game={}));
(function(c){var h=function(c){function b(){c.apply(this,arguments)}__extends(b,c);b.prototype.Start=function(){var a=this;c.prototype.Start.call(this);var b;[["GAME BY","KAKUS","","MUSIC BY","CARLOS PAZUZU"],["MADE WITH","\u2665","FOR","LOWREZJAM","2016"]].forEach(function(c,f){var h=new core.Layer(32,32,64,0);h.Anchor.Set(0,.5);h.Alpha=0;c.forEach(function(a,b){var c=new gfx.AAText(0,3+8*b,a);c.SetSize(5);c.Anchor.Set(.5,.5);"\u2665"===a[0]&&c.SetColor("red");h.Size.y+=c.Size.y+3;h.AddChild(c)});a.Stage.AddChild(h);
b=a.Tweens.New(h).Delay(1+5*f).Then().To({Alpha:1},1).Then().Delay(3).Then().To({Alpha:0},1).Start()});b.WhenDone(function(){return a.OnKeyDown(0)});this.DimScreen(!0,2);this.InputController=new core.GenericInputController;this.ListenForKeyboard();this.OnResize()};b.prototype.OnKeyUp=function(a){};b.prototype.OnKeyDown=function(a){this.Game.Play("menu")};return b}(c.AbstractState);c.SplashScreen=h})(state||(state={}));
(function(c){var h=function(c){function b(){c.apply(this,arguments)}__extends(b,c);b.prototype.Start=function(){this.IsKeyDown=[];this.CameraTweens=new core.TweenManager;this.DefaultSize.Set(64,64);this.ScreenCenter=new core.Vector(this.DefaultSize.x/2-12,this.DefaultSize.y/2-12);c.prototype.Start.call(this);game.context.PlayState=this;this.InputController=new core.GenericInputController;this.ListenForKeyboard();this.FPSText.Position.Set(0,0);this.OnResize();this.RestartPurgatory()};b.prototype.OnKeyUp=
function(a){this.IsKeyDown[a]=!1};b.prototype.OnKeyDown=function(a){this.IsKeyDown[a]=!0};b.prototype.Update=function(a){c.prototype.Update.call(this,a);this.CameraTweens.Update(a);this.FightMode&&(this.IsKeyDown[38]||this.IsKeyDown[87]||this.IsKeyDown[32]?this.FightMode.Flap():this.FightMode.Flip(),this.FightMode.Update(a));this.Purgatory&&(this.IsKeyDown[37]||this.IsKeyDown[65]?this.Purgatory.MovePlayer(0):this.IsKeyDown[38]||this.IsKeyDown[87]?this.Purgatory.MovePlayer(2):(this.IsKeyDown[39]||
this.IsKeyDown[68])&&this.Purgatory.MovePlayer(1),this.Purgatory.Update(a),this.CameraTweens.TweenPlaying()||this.CenterCamera())};b.prototype.OnResize=function(){c.prototype.OnResize.call(this)};b.prototype.BeginFigthMode=function(a){audio.manager.StopAll();var b=new game.TeethGenertor(game.theeth[a].upper,game.theeth[a].lower,game.theeth[a].gap,game.theeth[a].color);this.FightMode=new game.FightMode(0,0,b,a);this.Stage.AddChild(this.FightMode);this.Purgatory&&(this.Purgatory.RemoveFromParent(),
this.Purgatory=null)};b.prototype.RestartPurgatory=function(){audio.manager.StopAll();this.Purgatory&&this.Purgatory.RemoveFromParent();this.Stage.Alpha=1;this.DimScreen(!0);this.Purgatory=new game.Purgatory(.5,.5);this.Stage.AddChild(this.Purgatory)};b.prototype.BlinkScreen=function(a,b){void 0===a&&(a=1);void 0===b&&(b=.1);var c=new gfx.Rectangle(0,0,this.Stage.Size.x,this.Stage.Size.y,{fillStyle:"white",compositeOperation:"difference"});this.Stage.AddChild(c);var g=a/b|0;this.Timers.Repeat(b,function(a){a==
g?c.RemoveFromParent():c.Visible=!c.Visible},void 0,g)};b.prototype.MoveCameraTo=function(a,b){void 0===b&&(b=1);a=a.Clone();core.vector.Subtract(this.ScreenCenter,a,a);return this.CameraTweens.New(this.Purgatory.Position).To({x:a.x,y:a.y},b,core.easing.SinusoidalInOut).Start()};b.prototype.CenterCamera=function(){core.vector.Subtract(this.ScreenCenter,this.Purgatory.Player.Position,this.Purgatory.Position)};return b}(c.AbstractState);c.PlayState=h})(state||(state={}));
(function(c){var h=function(c){function b(){c.apply(this,arguments)}__extends(b,c);b.prototype.Start=function(){c.prototype.Start.call(this);game.context.Reset();var a=new gfx.SpriteSheet("spritesheet",new core.Vector(24,24)),b=game.assets.MAIN_MENU_SCENE;this.BgScene=new gfx.AnimatedSprite(0,7,64,64);b=this.BgScene.Animator.AddAnimation("idle",b.map(function(a,b){return b}),b.map(function(b){b=a.GetSprite(b);b.SourceRect.Size.Set(64,64);b.Size.Set(64,64);return b}));b.Loop=!0;b.Duration=2;this.BgScene.Animator.Play("idle");
b=new gfx.AAText(5,3,"SLUMBER KNIGHT");b.SetSize(5);var e=new gfx.AAText(17,50,"PRESS UP"),g=new gfx.AAText(17,56,"TO START");e.SetSize(5);g.SetSize(5);this.Stage.AddChild(this.BgScene,e,g,b);this.DimScreen(!0,2);this.Timers.Delay(0,function(){return audio.manager.Play("fireplace",1,!0)});this.InputController=new core.GenericInputController;this.ListenForKeyboard();this.OnResize()};b.prototype.Update=function(a){c.prototype.Update.call(this,a);this.BgScene.Update(a)};b.prototype.OnKeyUp=function(a){};
b.prototype.OnKeyDown=function(a){this.Game.Play("intro")};return b}(c.AbstractState);c.Menu=h})(state||(state={}));
(function(c){var h=function(c){function b(){c.apply(this,arguments)}__extends(b,c);b.prototype.Start=function(){var a=this;this.DefaultSize.Set(64,64);c.prototype.Start.call(this);var b=new gfx.AAText(15,30,"LOADING");b.SetSize(5);var e="",g=this.Timers.Repeat(.5,function(){e=3===e.length?"":e+".";b.SetText("LOADING "+e)});this.Stage.AddChild(b);var h=gfx.Sprite.Load(["spritesheet","assets/images/spritesheet.png"]),m=audio.manager.LoadAll([["fight-scene",["assets/audio/fight-scene-music.mp3"]],["fireplace",
["assets/audio/fireplace.mp3"]],["monster-fight",["assets/audio/monster-fight.wav"]],["demon-slayed",["assets/audio/demon-slayed.wav"]],["demon-hit",["assets/audio/demon-hit.wav"]],["floor-collapsing",["assets/audio/floor-collapsing.wav"]],["item-aquired",["assets/audio/item-aquired.wav"]],["you-died",["assets/audio/you-died.wav"]],["temple",["assets/audio/temple-music.mp3"]]]);Promise.all([h,m]).then(function(){a.Game.Play("splash")},function(a){g.Stop();b.SetText("ERROR");b.SetColor("red");console.error(a)});
this.OnResize()};return b}(c.AbstractState);c.LoadingState=h})(state||(state={}));
(function(c){var h=function(c){function b(){c.apply(this,arguments)}__extends(b,c);b.prototype.Start=function(){var a=this;this.IsKeyDown=[];this.DefaultSize.Set(64,64);c.prototype.Start.call(this);var b=new gfx.SpriteSheet("spritesheet",new core.Vector(24,24)),e=new gfx.AAText(17,27,"YOU DIED");e.SetSize(5);for(var g=function(a){var c=b.GetSprite(game.assets.HEART_FRAME),e=b.GetSprite(game.assets.HEART_FILL);c.Position.Set(14+10*a,35);e.Position.Set(14+10*a,35);h.Stage.AddChild(c);a<=game.context.LifesLeft&&
h.Stage.AddChild(e);a==game.context.LifesLeft&&h.Timers.Repeat(.3,function(){return e.Visible=!e.Visible},void 0,11)},h=this,m=0;4>m;++m)g(m);this.Stage.AddChild(e);this.DimScreen(!0,2);this.Timers.Delay(0,function(){return audio.manager.Play("you-died")});this.Timers.Delay(4,function(){return a.OnKeyDown(38)});this.InputController=new core.GenericInputController;this.ListenForKeyboard();this.OnResize()};b.prototype.OnKeyUp=function(a){this.IsKeyDown[a]=!1};b.prototype.OnKeyDown=function(a){0<game.context.LifesLeft?
this.Game.Play("play"):this.Game.Play("menu")};b.prototype.DimScreen=function(a,b){void 0===a&&(a=!1);void 0===b&&(b=2);a&&(this.Stage.Alpha=1-this.Stage.Alpha);return this.Tweens.New(this.Stage).To({Alpha:a?1:0},b).Start()};return b}(c.AbstractState);c.YouDiedState=h})(state||(state={}));
(function(c){var h=function(c){function b(){c.apply(this,arguments)}__extends(b,c);b.prototype.Start=function(){var a=this;this.DefaultSize.Set(64,64);c.prototype.Start.call(this);var b=new gfx.SpriteSheet("spritesheet",new core.Vector(24,24)),e=new gfx.AAText(9,27,"DEMON SLAIN");e.SetSize(5);for(var g=0;4>g;++g){var h=b.GetSprite(game.assets.HEART_FRAME),m=b.GetSprite(game.assets.HEART_FILL);h.Position.Set(14+10*g,35);m.Position.Set(14+10*g,35);this.Stage.AddChild(h);g<game.context.LifesLeft&&this.Stage.AddChild(m)}this.Stage.AddChild(e);
this.DimScreen(!0,2);this.Timers.Delay(0,function(){return audio.manager.Play("demon-slayed")});this.Timers.Delay(4,function(){return a.OnKeyDown(38)});this.InputController=new core.GenericInputController;this.ListenForKeyboard();this.OnResize()};b.prototype.OnKeyDown=function(a){game.context.AllDemonsKilled()?this.Game.Play("epilog"):this.Game.Play("play")};return b}(c.AbstractState);c.DemonSlayedState=h})(state||(state={}));
(function(c){var h=function(c){function b(){c.apply(this,arguments)}__extends(b,c);b.prototype.Start=function(){var a=this;this.DefaultSize.Set(64,64);c.prototype.Start.call(this);new gfx.SpriteSheet("spritesheet",new core.Vector(24,24));var b;["THEY","ALL","GONE","NOW"].forEach(function(c,e){var f=new gfx.AAText(32,32,c);f.Anchor.Set(.5,.5);f.SetSize(5);f.Alpha=0;a.Stage.AddChild(f);b=a.Tweens.New(f).Delay(1+2*e).Then().To({Alpha:1}).Then().To({Alpha:0}).WhenDone(function(){return f.RemoveFromParent()}).Start()});
b.WhenDone(function(){var b=new gfx.AAText(32,32,"WAKE UP!");b.Anchor.Set(.5,.5);b.SetSize(5);b.Alpha=0;a.Stage.AddChild(b);a.Tweens.New(b).Then().To({Alpha:1}).WhenDone(function(){return a.ShakeScreen(.5)}).Then().Delay(1).WhenDone(function(){b.Scale.Set(2,2);a.ShakeScreen(.5)}).Then().Delay(1).WhenDone(function(){return b.RemoveFromParent()}).Start()});var e=new core.Layer(0,74);"THANK YOU;FOR PLAYING;;FOR MORE NEWS;FOLLOW ME ON;TWITTER;KAKUS_DEV".split(";").forEach(function(a,b,c){a=new gfx.AAText(32,
7*b,a);a.SetSize(5);a.Anchor.Set(.5,.5);b==c.length-1&&a.SetColor("#55acee");e.AddChild(a)});this.Timers.Delay(15,function(){a.Stage.AddChild(e);a.Tweens.New(e.Position).To({y:12},5).Start()});this.DimScreen(!0,2);this.InputController=new core.GenericInputController;this.ListenForKeyboard();this.OnResize()};b.prototype.OnKeyDown=function(a){this.Game.Play("menu")};return b}(c.AbstractState);c.EpilogState=h})(state||(state={}));
(function(c){var h=function(b){return b.Set(Math.floor(b.x),Math.floor(b.y))},f=function(b){function a(){b.apply(this,arguments)}__extends(a,b);a.prototype.Start=function(){var a=this;b.prototype.Start.call(this);var c=new gfx.SpriteSheet("spritesheet",new core.Vector(24,24)),f=game.assets.INTRO_SCENE;this.Intro=new gfx.AnimatedSprite(0,0,64,64);this.Intro.Animator.AddAnimation("idle",f.map(function(a,b){return b}),f.map(function(a){a=c.GetSprite(a);a.SourceRect.Size.Set(64,64);a.SourceRect.Position.x+=
4;a.SourceRect.Position.y+=4;a.Size.Set(64,64);return a})).Duration=2;this.Intro.Animator.AddAnimation("freeze",[0],[f[0]].map(function(a){a=c.GetSprite(a);a.SourceRect.Size.Set(64,64);a.SourceRect.Position.x+=4;a.SourceRect.Position.y+=4;a.Size.Set(64,64);return a}));this.Intro.Animator.Play("freeze");this.Stage.AddChild(this.Intro);this.Intro.Position.Set(0,64);this.Tweens.New(this.Intro.Position).Delay(1).Then().To({y:0},2,core.easing.CubicOut).OnUpdate(h).Start().WhenDone(function(){a.Intro.Animator.Play("idle");
a.Timers.Delay(2,function(){a.DimScreen();a.Timers.Delay(2,function(){a.OnKeyDown(0)})})});this.DimScreen(!0,2);this.InputController=new core.GenericInputController;this.ListenForKeyboard();this.OnResize()};a.prototype.Update=function(a){b.prototype.Update.call(this,a);this.Intro.Update(a)};a.prototype.OnKeyUp=function(a){};a.prototype.OnKeyDown=function(a){this.Game.Play("you-died")};return a}(c.AbstractState);c.IntroState=f})(state||(state={}));var GAME=new core.Game("canvas");
GAME.AddState("splash",new state.SplashScreen);GAME.AddState("loading",new state.LoadingState);GAME.AddState("menu",new state.Menu);GAME.AddState("play",new state.PlayState);GAME.AddState("you-died",new state.YouDiedState);GAME.AddState("demon-slayed",new state.DemonSlayedState);GAME.AddState("epilog",new state.EpilogState);GAME.AddState("intro",new state.IntroState);GAME.Play("loading");GAME.Start();
